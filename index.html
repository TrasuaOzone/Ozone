<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>·ªû ƒê√¢y C√≥ G√¨? ‚Äî LU·ªíNG HO·∫†T ƒê·ªòNG (Ph·∫ßn 1)</title>

  <!-- Font Awesome cho bi·ªÉu t∆∞·ª£ng -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">

  <style>
    :root{
      --red:#C62828; --red-dark:#B71C1C; --bg:#FAFAFA; --field-br:12px; --field-bd:#E6E6E6;
      --bottom-nav-min-h:64px; --bottom-nav-pad:64px;
    }
    html,body{height:100%; margin:0; font-family:Inter,system-ui,Arial; background:var(--bg); color:#222; -webkit-font-smoothing:antialiased;}
    header{background:linear-gradient(135deg,var(--red),#FF5252); color:#fff; padding:16px; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap}
    .logo-left{display:flex;gap:12px;align-items:center}
    .logo-left img{width:56px;height:56px;border-radius:12px}
    .logo-left h1{margin:0;font-family:'Playfair Display',serif;font-size:20px}
    .header-actions{display:flex;gap:10px;align-items:center}
    .signup-button,.login-button{
      border-radius:12px;padding:10px 12px;font-weight:600;font-size:14px;border:0;cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;box-shadow:0 6px 14px rgba(0,0,0,.08)
    }
    .signup-button{background:#FFEBEE;color:var(--red);border:1px solid var(--red)}
    .login-button{background:var(--red);color:#fff}

    main{padding:14px 12px 120px}
    h2{font-size:18px;color:var(--red);margin:12px 0}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
    .card{background:#fff;border-radius:14px;padding:14px;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,.04);cursor:pointer;user-select:none}
    .card .emoji{font-size:20px;display:block}
    .card p{margin:8px 0 0;font-weight:700}

    .bottom-nav{position:fixed;left:0;right:0;bottom:0;background:#fff;padding:8px 10px;display:flex;justify-content:space-around;align-items:center;border-top-left-radius:12px;border-top-right-radius:12px;box-shadow:0 -8px 20px rgba(0,0,0,.06)}
    .bottom-nav a{color:var(--red);font-size:20px;text-decoration:none;padding:8px 12px;border-radius:10px}

    /* Overlay & Dialog */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999;padding:16px}
    .overlay.active{display:flex}
    .dialog{background:#fff;border-radius:14px;padding:18px;max-width:420px;width:100%;box-shadow:0 20px 50px rgba(0,0,0,.2);position:relative}
    .close-btn{position:absolute;top:10px;right:10px;width:36px;height:36px;border-radius:10px;border:2px solid var(--red);background:#fff;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
    .form{display:grid;gap:12px}
    .field label{font-weight:700;font-size:13px}
    .input{padding:10px 12px;border-radius:10px;border:1.5px solid var(--field-bd);outline:none}
    .input:focus{box-shadow:0 0 0 4px rgba(198,40,40,.08);border-color:var(--red)}
    .actions{display:flex;gap:8px;flex-direction:column}
    .btn-primary{background:var(--red);color:#fff;padding:12px;border-radius:10px;border:0;font-weight:800;cursor:pointer}
    .link-row{display:flex;justify-content:space-between;align-items:center;font-size:14px}
    .link-row a{color:var(--red);text-decoration:none;font-weight:700}

    /* Small helpers */
    .hidden{display:none}
    .session-info{background:#fff;border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 6px 18px rgba(0,0,0,.04)}
    .session-banner{display:none;background:#FFF0F1;border:1px solid #FFC1C4;padding:10px;border-radius:10px;color:var(--red);margin-bottom:12px}
    .help{font-size:13px;color:#666}
  </style>
</head>
<body>
  <header>
    <div class="logo-left">
      <img src="images/icon-512.png" alt="Logo">
      <div>
        <h1>·ªû ƒê√¢y C√≥ G√¨?</h1>
        <div class="help" style="color:rgba(255,255,255,.9)">K·∫øt n·ªëi y√™u th∆∞∆°ng ‚Äî th·ª≠ b·∫£n demo lu·ªìng</div>
      </div>
    </div>

    <div class="header-actions">
      <button id="signupLink" class="signup-button" onclick="openRegisterDialog()">üìù ƒêƒÉng k√Ω</button>
      <button id="loginBtn" class="login-button" aria-haspopup="dialog" onclick="openLoginDialog()">üîê ƒêƒÉng nh·∫≠p</button>
    </div>
  </header>

  <main id="mainContent">
    <!-- Session banner (s·∫Ω hi·ªÉn khi restore session g·∫∑p OTHER_DEVICE/LOCKED) -->
    <div id="sessionBanner" class="session-banner" role="status"></div>

    <!-- H·ªì s∆° (n·∫øu ƒë√£ login s·∫Ω ƒë∆∞·ª£c render) -->
    <div id="profileArea"></div>

    <h2>D·ªãch v·ª• y√™u th√≠ch</h2>
    <div class="grid" id="serviceGrid">
      <div class="card" data-href="bando.html" tabindex="0"><span class="emoji">üöó</span><p>ƒê·∫∑t xe</p></div>
      <div class="card" data-href="trasua.html" tabindex="0"><span class="emoji">üßã</span><p>ƒê·∫∑t n∆∞·ªõc</p></div>
      <div class="card" data-href="lamdep.html" tabindex="0"><span class="emoji">üíÖ</span><p>L√†m ƒë·∫πp - S·ª©c kh·ªèe</p></div>
      <div class="card" data-href="vanchuyen.html" tabindex="0"><span class="emoji">üì¶</span><p>V·∫≠n chuy·ªÉn</p></div>
      <div class="card" data-href="laodong.html" tabindex="0"><span class="emoji">üîé</span><p>T√¨m vi·ªác</p></div>
      <div class="card" data-href="raovat.html" tabindex="0"><span class="emoji">üì¢</span><p>Rao v·∫∑t</p></div>
    </div>
  </main>

  <nav class="bottom-nav" aria-label="ƒêi·ªÅu h∆∞·ªõng ch√≠nh">
    <a href="index.html">üè†</a>
    <a href="thongbao.html">üîî</a>
    <a href="lienhe.html">üìû</a>
    <a href="taikhoan.html">üë§</a>
  </nav>

  <!-- Overlay: Login -->
  <div id="overlayLogin" class="overlay" role="dialog" aria-modal="true" aria-labelledby="loginTitle" aria-hidden="true">
    <div class="dialog" role="document">
      <button class="close-btn" aria-label="ƒê√≥ng" onclick="closeLoginDialog()">‚úï</button>
      <h2 id="loginTitle" style="color:var(--red);margin:4px 0 12px;font-family:'Playfair Display',serif">ƒêƒÉng nh·∫≠p</h2>

      <form id="loginForm" class="form" onsubmit="return handleLogin(event)">
        <div class="field">
          <label for="loginPhone">S·ªë ƒëi·ªán tho·∫°i</label>
          <input id="loginPhone" class="input" type="tel" inputmode="tel" placeholder="0xxxxxxxxx" pattern="^0[0-9]{9}$" required>
        </div>

        <div class="field">
          <label for="loginPassword">M·∫≠t kh·∫©u</label>
          <div style="position:relative">
            <input id="loginPassword" class="input" type="password" placeholder="M·∫≠t kh·∫©u" required>
            <button type="button" id="togglePwdBtn" aria-label="Hi·ªán/·∫©n m·∫≠t kh·∫©u" style="position:absolute;right:8px;top:8px;border:0;background:transparent;cursor:pointer">
              <i class="fa fa-eye"></i>
            </button>
          </div>
        </div>

        <div class="link-row">
          <a href="javascript:void(0)" id="forgotPwdLink" onclick="openForgotDialog()">Qu√™n m·∫≠t kh·∫©u?</a>
          <a href="javascript:void(0)" id="toRegisterLink" onclick="openRegisterDialog()">Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω</a>
        </div>

        <div class="actions">
          <button id="loginSubmitBtn" class="btn-primary" type="submit">ƒêƒÉng nh·∫≠p</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Placeholder: Register dialog will be in next parts -->
  <!-- Placeholder: Forgot password dialog will be in next parts -->

  <script>
    /**************************************************************
     * PH·∫¶N 1: Login flow + API integration (Basic Auth)
     * - T√≠ch h·ª£p SID+SECRET d∆∞·ªõi d·∫°ng Basic Auth (nh∆∞ y√™u c·∫ßu).
     * - H√†m apiLogin() g·ªçi /api/login.
     * - L∆∞u session v√†o localStorage.key = 'odcg_customer'
     * - Ch·∫∑n click card khi ch∆∞a login.
     *
     * WARNING: ƒê·∫∑t kho√° tr·ª±c ti·∫øp trong client l√† R·∫§T KH√îNG AN TO√ÄN.
     **************************************************************/

    // ==========================
    // CONFIG: API KEY (FROM USER)
    // ==========================
    // NOTE: B·∫°n ƒë√£ cung c·∫•p SID & SECRET; ƒë·ªÉ th·ª≠ nhanh m√¨nh ch√®n tr·ª±c ti·∫øp.
    const API_SID = 'SK.0.2F1uFWBnNc65QHlINyXooG464lIbwZCX';
    const API_SECRET = 'VlRSM0t6b1lOTXlOdW1jUmpYREFrNFBkWmlPaXZuOW8=';

    // N·∫øu b·∫°n mu·ªën g·ªçi t·ªõi server proxy (an to√†n), set BASE_API_URL th√†nh URL server
    const BASE_API_URL = '/api'; // gi·∫£ ƒë·ªãnh: proxy ho·∫∑c server backend route; (v√≠ d·ª• /api/login)

    // ==========================
    // UTILS
    // ==========================
    function b64(s){ try { return btoa(s); } catch(e){ return ''; } }
    function ensureDeviceId(){
      let id = localStorage.getItem('odcg_device_id');
      if(!id){ id = 'dev-' + Date.now() + '-' + Math.random().toString(36).slice(2,9); localStorage.setItem('odcg_device_id', id); }
      return id;
    }

    function showOverlay(el){ el.classList.add('active'); el.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
    function hideOverlay(el){ el.classList.remove('active'); el.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }

    // ==========================
    // API: login
    // ==========================
    async function apiLogin(phone, password) {
      // Authorization: Basic base64(SID:SECRET)
      const authHeader = 'Basic ' + b64(API_SID + ':' + API_SECRET);

      const payload = { phone, password, deviceId: ensureDeviceId() };

      // Note: endpoint path /login (replace as needed)
      const url = BASE_API_URL + '/login';

      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': authHeader
          },
          body: JSON.stringify(payload)
        });
        // Try parse JSON
        const text = await res.text();
        try { return JSON.parse(text); } catch(e){ return { ok: res.ok, message: text }; }
      } catch (err) {
        return { ok:false, message: err.message || 'Network error' };
      }
    }

    // ==========================
    // Session / UI helpers
    // ==========================
    function setAuthButtonsVisibility(isLoggedIn){
      const loginBtn = document.getElementById('loginBtn');
      const signupLink = document.getElementById('signupLink');
      if(loginBtn) loginBtn.style.display = isLoggedIn ? 'none' : '';
      if(signupLink) signupLink.style.display = isLoggedIn ? 'none' : '';
    }

    function renderBasicCustomerInfo({ name, phone, address, mapUrl }) {
      const area = document.getElementById('profileArea');
      area.innerHTML = '';
      const section = document.createElement('div');
      section.className = 'session-info';
      section.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <div>
            <div style="font-weight:800">${name || ''}</div>
            <div class="help">${phone || ''}</div>
            <div class="help" style="margin-top:6px">${address || ''} ${mapUrl ? '<a href="'+mapUrl+'" target="_blank" style="margin-left:8px;color:var(--red)">v·ªã tr√≠</a>' : ''}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <button id="btnProfession" class="signup-button" style="min-width:150px">üíº ƒêƒÉng k√Ω ng√†nh ngh·ªÅ</button>
            <button id="btnLogout" class="login-button" style="min-width:120px;background:#fff;color:var(--red);border:1px solid var(--red)">üö™ ƒêƒÉng xu·∫•t</button>
          </div>
        </div>
      `;
      area.appendChild(section);

      document.getElementById('btnLogout').addEventListener('click', apiLogout);
      document.getElementById('btnProfession').addEventListener('click', openProfessionDialog);

      setAuthButtonsVisibility(true);
    }

    function removeBasicCustomerInfo(){
      const area = document.getElementById('profileArea');
      area.innerHTML = '';
      setAuthButtonsVisibility(false);
    }

    // ==========================
    // Login handler (UI)
    // ==========================
    const overlayLogin = document.getElementById('overlayLogin');
    function openLoginDialog(){ showOverlay(overlayLogin); setTimeout(()=>document.getElementById('loginPhone').focus(),80); }
    function closeLoginDialog(){ hideOverlay(overlayLogin); }

    document.getElementById('togglePwdBtn').addEventListener('click', function(){
      const input = document.getElementById('loginPassword');
      const icon = this.querySelector('i');
      if(input.type === 'password'){ input.type = 'text'; icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash'); }
      else { input.type = 'password'; icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye'); }
    });

    async function handleLogin(e){
      e.preventDefault();
      const phone = document.getElementById('loginPhone').value.trim();
      const password = document.getElementById('loginPassword').value;
      if(!/^0[0-9]{9}$/.test(phone)){ alert('Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i h·ª£p l·ªá (10 ch·ªØ s·ªë, b·∫Øt ƒë·∫ßu 0)'); document.getElementById('loginPhone').focus(); return false; }
      if(!password){ alert('Nh·∫≠p m·∫≠t kh·∫©u'); document.getElementById('loginPassword').focus(); return false; }

      const btn = document.getElementById('loginSubmitBtn');
      btn.disabled = true; btn.textContent = '‚è≥ ƒêang ƒëƒÉng nh·∫≠p...';

      try{
        const res = await apiLogin(phone, password);
        if(!res || !res.ok){
          alert(res && res.message ? ('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: ' + res.message) : 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i');
          return false;
        }

        // Backend tr·∫£ v·ªÅ sessionId v√† customer info
        const sessionId = res.sessionId || res.data?.sessionId || res.session?.id;
        const customer = res.customer || res.data?.customer || { name: res.name || '', phone: phone, address: res.address || '' };

        // L∆∞u localStorage
        const store = {
          name: customer.name || '',
          phone: customer.phone || phone,
          address: customer.address || '',
          mapUrl: customer.mapUrl || '',
          sessionId: sessionId || '',
          deviceId: ensureDeviceId(),
          t: Date.now()
        };
        localStorage.setItem('odcg_customer', JSON.stringify(store));

        // UI
        closeLoginDialog();
        renderBasicCustomerInfo({ name: store.name, phone: store.phone, address: store.address, mapUrl: store.mapUrl });

        // Start ping loop (will be in next parts but schedule minimal ping here)
        schedulePingLoop();

      } catch(err){
        alert('L·ªói khi ƒëƒÉng nh·∫≠p: ' + (err.message || err));
      } finally {
        btn.disabled = false; btn.textContent = 'ƒêƒÉng nh·∫≠p';
      }
      return false;
    }

    // ==========================
    // Logout
    // ==========================
    async function apiLogout(){
      const s = JSON.parse(localStorage.getItem('odcg_customer') || '{}');
      // If no session, simply clear
      if(!s.sessionId){ localStorage.removeItem('odcg_customer'); removeBasicCustomerInfo(); return; }

      // call logout API (uses same Basic Auth)
      const authHeader = 'Basic ' + b64(API_SID + ':' + API_SECRET);
      try{
        const res = await fetch(BASE_API_URL + '/logout_user', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Authorization': authHeader },
          body: JSON.stringify({ phone: s.phone, deviceId: s.deviceId, sessionId: s.sessionId })
        });
        const txt = await res.text();
        // optional: alert server message
        if(txt) console.log('logout response', txt);
      } catch(e){
        console.warn('Logout API failed', e);
      } finally {
        localStorage.removeItem('odcg_customer');
        removeBasicCustomerInfo();
        alert('B·∫°n ƒë√£ ƒëƒÉng xu·∫•t.');
      }
    }

    // ==========================
    // Ping session & restore on load
    // ==========================
    async function pingSession({ phone, deviceId, sessionId }){
      const authHeader = 'Basic ' + b64(API_SID + ':' + API_SECRET);
      try{
        const res = await fetch(BASE_API_URL + '/ping_session', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Authorization': authHeader },
          body: JSON.stringify({ phone, deviceId, sessionId })
        });
        const txt = await res.text();
        try { return JSON.parse(txt); } catch { return { ok:false, raw:txt }; }
      } catch(e){ return { ok:false, message: e.message }; }
    }

    let pingLoopTimer = null;
    function schedulePingLoop(){
      // Minimal: ping every 60s (you can increase)
      if(pingLoopTimer) clearInterval(pingLoopTimer);
      pingLoopTimer = setInterval(async ()=>{
        const s = JSON.parse(localStorage.getItem('odcg_customer') || '{}');
        if(!s || !s.phone || !s.sessionId) { clearInterval(pingLoopTimer); return; }
        try{
          const pr = await pingSession({ phone: s.phone, deviceId: s.deviceId, sessionId: s.sessionId });
          if(pr && pr.status){
            if(pr.status === 'ACTIVE'){ /* ok */ }
            else if(pr.status === 'OTHER_DEVICE'){ document.getElementById('sessionBanner').textContent = 'S·ªë ƒëi·ªán tho·∫°i n√†y ƒëang ƒëƒÉng nh·∫≠p ·ªü n∆°i kh√°c. Phi√™n hi·ªán t·∫°i ƒë√£ b·ªã ƒëƒÉng xu·∫•t.'; document.getElementById('sessionBanner').style.display='block'; localStorage.removeItem('odcg_customer'); removeBasicCustomerInfo(); clearInterval(pingLoopTimer); }
            else if(pr.status === 'LOCKED'){ document.getElementById('sessionBanner').textContent = 'S·ªë ƒëi·ªán tho·∫°i n√†y b·ªã kho√° trong 24 gi·ªù.'; document.getElementById('sessionBanner').style.display='block'; localStorage.removeItem('odcg_customer'); removeBasicCustomerInfo(); clearInterval(pingLoopTimer); }
            else { /* unknown -> clear */ localStorage.removeItem('odcg_customer'); removeBasicCustomerInfo(); clearInterval(pingLoopTimer); }
          }
        } catch(e){ console.warn('pingSession error', e); }
      }, 60000);
    }

    async function restoreSessionIfAny(){
      const s = JSON.parse(localStorage.getItem('odcg_customer') || '{}');
      if(!s || !s.phone || !s.sessionId){ setAuthButtonsVisibility(false); return; }
      try{
        const pr = await pingSession({ phone: s.phone, deviceId: s.deviceId, sessionId: s.sessionId });
        if(pr && pr.status === 'ACTIVE'){
          renderBasicCustomerInfo({ name: pr.customer?.name || s.name, phone: pr.customer?.phone || s.phone, address: pr.customer?.address || s.address, mapUrl: pr.customer?.mapUrl || s.mapUrl });
          document.getElementById('sessionBanner').style.display = 'none';
          schedulePingLoop();
        } else if(pr && pr.status === 'OTHER_DEVICE'){
          document.getElementById('sessionBanner').textContent = 'S·ªë ƒëi·ªán tho·∫°i n√†y ƒëang ƒëƒÉng nh·∫≠p ·ªü n∆°i kh√°c. Phi√™n c·ª•c hi·ªán t·∫°i ƒë√£ b·ªã ƒëƒÉng xu·∫•t.'; document.getElementById('sessionBanner').style.display='block';
          localStorage.removeItem('odcg_customer'); removeBasicCustomerInfo();
        } else {
          localStorage.removeItem('odcg_customer'); removeBasicCustomerInfo();
        }
      } catch(e){
        console.warn('restoreSessionIfAny error', e);
        setAuthButtonsVisibility(false);
      }
    }

    window.addEventListener('load', ()=>{ restoreSessionIfAny(); updateCardClickHandlers(); });

    // ==========================
    // Card click blocker (ch·∫∑n n·∫øu ch∆∞a login)
    // ==========================
    function isLoggedIn(){
      const s = JSON.parse(localStorage.getItem('odcg_customer') || '{}');
      return !!(s && s.sessionId);
    }

    function updateCardClickHandlers(){
      document.querySelectorAll('.card').forEach(card=>{
        card.removeEventListener('click', cardClickHandler);
        card.addEventListener('click', cardClickHandler);
        card.addEventListener('keydown', function(e){ if(e.key === 'Enter') cardClickHandler.call(this, e); });
      });
    }

    function cardClickHandler(e){
      const card = e.currentTarget;
      const href = card.getAttribute('data-href') || '#';
      if(!isLoggedIn()){
        e.preventDefault();
        e.stopPropagation();
        // show login notice (simple)
        if(confirm('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng n√†y. ƒêƒÉng nh·∫≠p ngay?')){
          openLoginDialog();
        }
        return;
      }
      // n·∫øu ƒë√£ login -> ƒëi·ªÅu h∆∞·ªõng
      window.location.href = href;
    }

    // ==========================
    // Open Register / Forgot / Profession placeholders
    // (actual full dialogs will be in subsequent parts)
    // ==========================
    function openRegisterDialog(){
      // placeholder: will be replaced by multi-step register in next parts
      alert('Popup ƒëƒÉng k√Ω (multi-step OTP) s·∫Ω ƒë∆∞·ª£c m·ªü trong ph·∫ßn ti·∫øp theo.'); 
    }
    function openForgotDialog(){
      alert('Popup Qu√™n m·∫≠t kh·∫©u s·∫Ω ƒë∆∞·ª£c m·ªü trong ph·∫ßn ti·∫øp theo.');
    }
    function openProfessionDialog(){
      alert('Popup ƒêƒÉng k√Ω ng√†nh ngh·ªÅ s·∫Ω ƒë∆∞·ª£c m·ªü trong ph·∫ßn ti·∫øp theo.');
    }

    // Quick hook for links in header
    document.getElementById('toRegisterLink').addEventListener('click', openRegisterDialog);
    document.getElementById('forgotPwdLink').addEventListener('click', openForgotDialog);
    document.getElementById('signupLink').addEventListener('click', openRegisterDialog);

  </script>
</body>
</html>
  <!-- Overlay: Register (multi-step) -->
  <div id="overlayRegister" class="overlay" role="dialog" aria-modal="true" aria-labelledby="registerTitle" aria-hidden="true">
    <div class="dialog" role="document">
      <button class="close-btn" aria-label="ƒê√≥ng" onclick="closeRegisterDialog()">‚úï</button>
      <h2 id="registerTitle" style="color:var(--red);margin:4px 0 12px;font-family:'Playfair Display',serif">ƒêƒÉng k√Ω</h2>

      <!-- Step container -->
      <form id="registerForm" class="form" onsubmit="return handleRegister(event)">
        <!-- B∆∞·ªõc 1: nh·∫≠p SƒêT -->
        <div class="step step-1">
          <div class="field">
            <label for="regPhone">S·ªë ƒëi·ªán tho·∫°i</label>
            <input id="regPhone" class="input" type="tel" placeholder="0xxxxxxxxx" pattern="^0[0-9]{9}$" required>
          </div>
          <button type="button" class="btn-primary" onclick="sendOTP()">G·ª≠i OTP</button>
        </div>

        <!-- B∆∞·ªõc 2: nh·∫≠p OTP -->
        <div class="step step-2 hidden">
          <div class="field">
            <label for="regOtp">M√£ OTP</label>
            <input id="regOtp" class="input" type="text" placeholder="Nh·∫≠p m√£ OTP" required>
          </div>
          <button type="button" class="btn-primary" onclick="verifyOTP()">X√°c th·ª±c OTP</button>
        </div>

        <!-- B∆∞·ªõc 3: ƒë·∫∑t m·∫≠t kh·∫©u -->
        <div class="step step-3 hidden">
          <div class="field">
            <label for="regPassword">M·∫≠t kh·∫©u</label>
            <input id="regPassword" class="input" type="password" placeholder="M·∫≠t kh·∫©u l·∫ßn ƒë·∫ßu" required>
          </div>
          <button type="button" class="btn-primary" onclick="nextStep(4)">Ti·∫øp t·ª•c</button>
        </div>

        <!-- B∆∞·ªõc 4: nh·∫≠p t√™n + ƒë·ªãa ch·ªâ -->
        <div class="step step-4 hidden">
          <div class="field">
            <label for="regName">H·ªç v√† t√™n</label>
            <input id="regName" class="input" type="text" placeholder="H·ªç t√™n ƒë·∫ßy ƒë·ªß" required>
          </div>
          <div class="field">
            <label for="regAddress">ƒê·ªãa ch·ªâ</label>
            <input id="regAddress" class="input" type="text" placeholder="ƒê·ªãa ch·ªâ c∆∞ tr√∫" required>
          </div>
          <div class="field">
            <label><input type="checkbox" id="regTerms" required> T√¥i ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu kho·∫£n s·ª≠ d·ª•ng</label>
          </div>
          <button type="submit" class="btn-primary">Ho√†n t·∫•t ƒëƒÉng k√Ω</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ================
    // ƒêƒÇNG K√ù (multi-step)
    // ================
    const overlayRegister = document.getElementById('overlayRegister');
    function openRegisterDialog(){ showOverlay(overlayRegister); showStep(1); }
    function closeRegisterDialog(){ hideOverlay(overlayRegister); }

    function showStep(n){
      document.querySelectorAll('#registerForm .step').forEach(s=>s.classList.add('hidden'));
      const step = document.querySelector('#registerForm .step-' + n);
      if(step) step.classList.remove('hidden');
      currentStep = n;
    }
    function nextStep(n){ showStep(n); }
    let currentStep = 1;

    // API helper
    function authHeader(){
      return 'Basic ' + b64(API_SID + ':' + API_SECRET);
    }

    async function sendOTP(){
      const phone = document.getElementById('regPhone').value.trim();
      if(!/^0[0-9]{9}$/.test(phone)){ alert('Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i h·ª£p l·ªá!'); return; }
      try{
        const res = await fetch(BASE_API_URL+'/send-otp', {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Authorization':authHeader() },
          body: JSON.stringify({ phone })
        });
        const data = await res.json();
        if(data.ok){ alert('OTP ƒë√£ ƒë∆∞·ª£c g·ª≠i.'); nextStep(2); }
        else { alert('Kh√¥ng g·ª≠i ƒë∆∞·ª£c OTP: '+(data.message||'')); }
      }catch(e){ alert('L·ªói g·ª≠i OTP: '+e.message); }
    }

    async function verifyOTP(){
      const phone = document.getElementById('regPhone').value.trim();
      const otp = document.getElementById('regOtp').value.trim();
      if(!otp){ alert('Nh·∫≠p OTP'); return; }
      try{
        const res = await fetch(BASE_API_URL+'/verify-otp', {
          method:'POST',
          headers:{ 'Content-Type':'application/json','Authorization':authHeader() },
          body: JSON.stringify({ phone, otp })
        });
        const data = await res.json();
        if(data.ok){ alert('OTP x√°c th·ª±c th√†nh c√¥ng.'); nextStep(3); }
        else { alert('OTP kh√¥ng h·ª£p l·ªá: '+(data.message||'')); }
      }catch(e){ alert('L·ªói x√°c th·ª±c OTP: '+e.message); }
    }

    async function handleRegister(e){
      e.preventDefault();
      const phone = document.getElementById('regPhone').value.trim();
      const password = document.getElementById('regPassword').value;
      const name = document.getElementById('regName').value.trim();
      const address = document.getElementById('regAddress').value.trim();
      const agreed = document.getElementById('regTerms').checked;
      if(!phone || !password || !name || !address || !agreed){
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin.'); return false;
      }

      try{
        const res = await fetch(BASE_API_URL+'/register-profile', {
          method:'POST',
          headers:{ 'Content-Type':'application/json','Authorization':authHeader() },
          body: JSON.stringify({ phone, password, name, address })
        });
        const data = await res.json();
        if(data.ok){
          alert('ƒêƒÉng k√Ω th√†nh c√¥ng!');
          closeRegisterDialog();
          // T·ª± ƒë·ªông ƒëƒÉng nh·∫≠p
          const sessionId = data.sessionId || data.data?.sessionId;
          const store = {
            name, phone, address,
            sessionId: sessionId || '',
            deviceId: ensureDeviceId(),
            t: Date.now()
          };
          localStorage.setItem('odcg_customer', JSON.stringify(store));
          renderBasicCustomerInfo(store);
          schedulePingLoop();
        } else {
          alert('ƒêƒÉng k√Ω th·∫•t b·∫°i: '+(data.message||'')); 
        }
      }catch(e){ alert('L·ªói ƒëƒÉng k√Ω: '+e.message); }
    }
  </script>
  <!-- Overlay: Qu√™n m·∫≠t kh·∫©u -->
  <div id="overlayForgot" class="overlay" role="dialog" aria-modal="true" aria-labelledby="forgotTitle" aria-hidden="true">
    <div class="dialog" role="document">
      <button class="close-btn" aria-label="ƒê√≥ng" onclick="closeForgotDialog()">‚úï</button>
      <h2 id="forgotTitle" style="color:var(--red);margin:4px 0 12px;font-family:'Playfair Display',serif">Qu√™n m·∫≠t kh·∫©u</h2>

      <form id="forgotForm" class="form" onsubmit="return handleForgot(event)">
        <!-- B∆∞·ªõc 1: nh·∫≠p SƒêT -->
        <div class="fp-step fp-step-1">
          <div class="field">
            <label for="fpPhone">S·ªë ƒëi·ªán tho·∫°i</label>
            <input id="fpPhone" class="input" type="tel" placeholder="0xxxxxxxxx" pattern="^0[0-9]{9}$" required>
          </div>
          <button type="button" class="btn-primary" onclick="fpSendOTP()">G·ª≠i OTP</button>
        </div>

        <!-- B∆∞·ªõc 2: nh·∫≠p OTP -->
        <div class="fp-step fp-step-2 hidden">
          <div class="field">
            <label for="fpOtp">M√£ OTP</label>
            <input id="fpOtp" class="input" type="text" placeholder="Nh·∫≠p OTP" required>
          </div>
          <button type="button" class="btn-primary" onclick="fpVerifyOTP()">X√°c th·ª±c OTP</button>
        </div>

        <!-- B∆∞·ªõc 3: nh·∫≠p m·∫≠t kh·∫©u m·ªõi -->
        <div class="fp-step fp-step-3 hidden">
          <div class="field">
            <label for="fpNewPwd">M·∫≠t kh·∫©u m·ªõi</label>
            <input id="fpNewPwd" class="input" type="password" placeholder="M·∫≠t kh·∫©u m·ªõi" required>
          </div>
          <button type="submit" class="btn-primary">ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ================
    // QU√äN M·∫¨T KH·∫®U
    // ================
    const overlayForgot = document.getElementById('overlayForgot');
    function openForgotDialog(){ showOverlay(overlayForgot); fpShowStep(1); }
    function closeForgotDialog(){ hideOverlay(overlayForgot); }

    function fpShowStep(n){
      document.querySelectorAll('#forgotForm .fp-step').forEach(s=>s.classList.add('hidden'));
      const step = document.querySelector('#forgotForm .fp-step-'+n);
      if(step) step.classList.remove('hidden');
      fpCurrentStep = n;
    }
    let fpCurrentStep = 1;

    async function fpSendOTP(){
      const phone = document.getElementById('fpPhone').value.trim();
      if(!/^0[0-9]{9}$/.test(phone)){ alert('Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i h·ª£p l·ªá!'); return; }
      try{
        const res = await fetch(BASE_API_URL+'/send-otp', {
          method:'POST',
          headers:{ 'Content-Type':'application/json','Authorization':authHeader() },
          body: JSON.stringify({ phone })
        });
        const data = await res.json();
        if(data.ok){ alert('OTP ƒë√£ g·ª≠i.'); fpShowStep(2); }
        else { alert('Kh√¥ng g·ª≠i ƒë∆∞·ª£c OTP: '+(data.message||'')); }
      }catch(e){ alert('L·ªói g·ª≠i OTP: '+e.message); }
    }

    async function fpVerifyOTP(){
      const phone = document.getElementById('fpPhone').value.trim();
      const otp = document.getElementById('fpOtp').value.trim();
      if(!otp){ alert('Nh·∫≠p OTP'); return; }
      try{
        const res = await fetch(BASE_API_URL+'/verify-otp', {
          method:'POST',
          headers:{ 'Content-Type':'application/json','Authorization':authHeader() },
          body: JSON.stringify({ phone, otp })
        });
        const data = await res.json();
        if(data.ok){ alert('OTP h·ª£p l·ªá.'); fpShowStep(3); }
        else { alert('OTP sai: '+(data.message||'')); }
      }catch(e){ alert('L·ªói x√°c th·ª±c OTP: '+e.message); }
    }

    async function handleForgot(e){
      e.preventDefault();
      const phone = document.getElementById('fpPhone').value.trim();
      const otp = document.getElementById('fpOtp').value.trim();
      const newPassword = document.getElementById('fpNewPwd').value;
      if(!newPassword){ alert('Nh·∫≠p m·∫≠t kh·∫©u m·ªõi'); return false; }
      try{
        const res = await fetch(BASE_API_URL+'/set-password', {
          method:'POST',
          headers:{ 'Content-Type':'application/json','Authorization':authHeader() },
          body: JSON.stringify({ phone, otp, newPassword })
        });
        const data = await res.json();
        if(data.ok){
          alert('M·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t l·∫°i, h√£y ƒëƒÉng nh·∫≠p.');
          closeForgotDialog();
          openLoginDialog();
        } else {
          alert('Kh√¥ng ƒë·∫∑t l·∫°i ƒë∆∞·ª£c m·∫≠t kh·∫©u: '+(data.message||'')); 
        }
      }catch(e){ alert('L·ªói ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u: '+e.message); }
      return false;
    }
  </script>
  <!-- Overlay: ƒêƒÉng k√Ω ng√†nh ngh·ªÅ -->
  <div id="overlayProfession" class="overlay" role="dialog" aria-modal="true" aria-labelledby="professionTitle" aria-hidden="true">
    <div class="dialog" role="document">
      <button class="close-btn" aria-label="ƒê√≥ng" onclick="closeProfessionDialog()">‚úï</button>
      <h2 id="professionTitle" style="color:var(--red);margin:4px 0 12px;font-family:'Playfair Display',serif">ƒêƒÉng k√Ω ng√†nh ngh·ªÅ</h2>

      <form id="professionForm" class="form" onsubmit="return handleProfession(event)">
        <div class="field">
          <label for="profSelect">Ng√†nh ngh·ªÅ</label>
          <select id="profSelect" class="input" required>
            <option value="">-- Ch·ªçn --</option>
            <option value="driver">üöó T√†i x·∫ø</option>
            <option value="store">üè™ C·ª≠a h√†ng</option>
            <option value="worker">üõ†Ô∏è Th·ª£</option>
            <option value="other">Kh√°c</option>
          </select>
        </div>

        <div class="field">
          <label for="profInfo">Th√¥ng tin chuy√™n m√¥n</label>
          <textarea id="profInfo" class="input" rows="3" placeholder="B·∫±ng l√°i, CCCD, kinh nghi·ªám..." required></textarea>
        </div>

        <div class="field">
          <label for="profArea">Khu v·ª±c ho·∫°t ƒë·ªông</label>
          <input id="profArea" class="input" type="text" placeholder="VD: Qu·∫≠n 1, TP.HCM" required>
        </div>

        <button type="submit" class="btn-primary">L∆∞u h·ªì s∆° ng√†nh ngh·ªÅ</button>
      </form>
    </div>
  </div>

  <script>
    // ================
    // ƒêƒÇNG K√ù NG√ÄNH NGH·ªÄ
    // ================
    const overlayProfession = document.getElementById('overlayProfession');
    function openProfessionDialog(){ showOverlay(overlayProfession); }
    function closeProfessionDialog(){ hideOverlay(overlayProfession); }

    async function handleProfession(e){
      e.preventDefault();
      const prof = document.getElementById('profSelect').value;
      const info = document.getElementById('profInfo').value.trim();
      const area = document.getElementById('profArea').value.trim();
      if(!prof || !info || !area){ alert('ƒêi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!'); return false; }

      const s = JSON.parse(localStorage.getItem('odcg_customer')||'{}');
      if(!s.sessionId){ alert('B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p.'); closeProfessionDialog(); return false; }

      try{
        const res = await fetch(BASE_API_URL+'/add-profession', {
          method:'POST',
          headers:{ 'Content-Type':'application/json','Authorization':authHeader() },
          body: JSON.stringify({ phone: s.phone, sessionId: s.sessionId, profession: prof, info, area })
        });
        const data = await res.json();
        if(data.ok){
          alert('ƒêƒÉng k√Ω ng√†nh ngh·ªÅ th√†nh c√¥ng!');
          closeProfessionDialog();
          // c·∫≠p nh·∫≠t h·ªì s∆° trong localStorage
          s.profession = { name: prof, info, area };
          localStorage.setItem('odcg_customer', JSON.stringify(s));
          renderBasicCustomerInfo(s);
        } else {
          alert('Kh√¥ng ƒëƒÉng k√Ω ƒë∆∞·ª£c: '+(data.message||'')); 
        }
      }catch(e){ alert('L·ªói khi ƒëƒÉng k√Ω ng√†nh ngh·ªÅ: '+e.message); }
      return false;
    }
  </script>
  <script>
    /*****************************************************
     * PH·∫¶N 5: HO√ÄN THI·ªÜN & TINH CH·ªàNH
     *****************************************************/

    // Reset form m·ªói l·∫ßn m·ªü popup
    function resetForm(el){ if(el) el.reset && el.reset(); }

    // Khi m·ªü/ƒë√≥ng Login
    function openLoginDialog(){ resetForm(document.getElementById('loginForm')); showOverlay(overlayLogin); setTimeout(()=>document.getElementById('loginPhone').focus(),80); }
    function closeLoginDialog(){ hideOverlay(overlayLogin); }

    // Khi m·ªü/ƒë√≥ng Register
    function openRegisterDialog(){ resetForm(document.getElementById('registerForm')); showOverlay(overlayRegister); showStep(1); setTimeout(()=>document.getElementById('regPhone').focus(),80); }
    function closeRegisterDialog(){ hideOverlay(overlayRegister); }

    // Khi m·ªü/ƒë√≥ng Forgot Password
    function openForgotDialog(){ resetForm(document.getElementById('forgotForm')); showOverlay(overlayForgot); fpShowStep(1); setTimeout(()=>document.getElementById('fpPhone').focus(),80); }
    function closeForgotDialog(){ hideOverlay(overlayForgot); }

    // Khi m·ªü/ƒë√≥ng Profession
    function openProfessionDialog(){ resetForm(document.getElementById('professionForm')); showOverlay(overlayProfession); setTimeout(()=>document.getElementById('profSelect').focus(),80); }
    function closeProfessionDialog(){ hideOverlay(overlayProfession); }

    // C·∫£nh b√°o b·∫£o m·∫≠t
    console.warn("‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n ƒëang ƒë·∫∑t API SID/SECRET tr·ª±c ti·∫øp trong client. ƒêi·ªÅu n√†y KH√îNG AN TO√ÄN. H√£y tri·ªÉn khai proxy server ƒë·ªÉ gi·∫•u kh√≥a, client ch·ªâ n√™n d√πng sessionId.");

    // Tr·∫£i nghi·ªám m∆∞·ª£t h∆°n: ƒë√≥ng popup b·∫±ng ph√≠m Esc
    document.addEventListener('keydown', e=>{
      if(e.key === 'Escape'){
        [overlayLogin, overlayRegister, overlayForgot, overlayProfession].forEach(o=>{
          if(o.classList.contains('active')) hideOverlay(o);
        });
      }
    });

    // Ch·∫∑n submit form m·∫∑c ƒë·ªãnh khi Enter trong OTP field n·∫øu ch∆∞a ƒë·∫øn b∆∞·ªõc cu·ªëi
    document.querySelectorAll('#registerForm input, #forgotForm input').forEach(inp=>{
      inp.addEventListener('keydown', e=>{
        if(e.key==='Enter'){ e.preventDefault(); }
      });
    });
  </script>
</body>
</html>
