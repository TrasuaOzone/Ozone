<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
<!-- B·∫ÆT ƒê·∫¶U CH√àN - Font Awesome cho icon con m·∫Øt -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<!-- K·∫æT TH√öC CH√àN -->

  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>·ªû ƒê√¢y C√≥ G√¨?</title>
  <meta name="description" content="·ªû ƒê√¢y C√≥ G√¨? ‚Äî K·∫øt n·ªëi y√™u th∆∞∆°ng: ƒë·∫∑t xe, ƒë·ªì u·ªëng, l√†m ƒë·∫πp, v·∫≠n chuy·ªÉn, vi·ªác l√†m v√† nhi·ªÅu d·ªãch v·ª• ti·ªán √≠ch kh√°c." />
  <meta name="theme-color" content="#C62828" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">

  <!-- Leaflet (map picker) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">

  <style>
    :root{
      --red:#C62828; --red-dark:#B71C1C; --light-red:#FFCDD2; --bg:#FAFAFA;
      --bottom-nav-min-h:64px; --bottom-nav-pad:64px;
      --field-br:12px; --field-bd:#E6E6E6;
    }
/* B·∫ÆT ƒê·∫¶U CH√àN - Canh ch·ªânh √¥ nh·∫≠p trong dialog */
.dialog form {
  max-width: 100%;
  width: 100%;
  box-sizing: border-box;
}

.input {
  max-width: 100%;
  box-sizing: border-box;
}
#registerDialog {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 10000;
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  width: 100%;
  max-width: 400px;
  box-sizing: border-box;
}


.location-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 8px;
}

.location-buttons button {
  flex: 1 1 45%;
  min-width: 120px;
  font-size: 15px;
  padding: 8px;
}

@media (max-width: 480px) {
  #registerDialog {
    padding: 16px;
    max-width: 90%;
  }

  #registerDialog input,
  #registerDialog button {
    font-size: 16px;
  }

  .location-buttons button {
    flex: 1 1 100%;
  }
}

.form input,
.expert-form input {
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
}
/* K·∫æT TH√öC CH√àN */
#registerDialog {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 10000;
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}


    html,body{height:100%}
    body{
      margin:0; font-family:'Inter',sans-serif; background:var(--bg); color:#212121;
      -webkit-text-size-adjust:100%; -webkit-tap-highlight-color:transparent;
      animation:pageFadeIn .4s ease-in; padding-bottom:var(--bottom-nav-pad);
    }
    @keyframes pageFadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    section h2{font-size:18px;margin:16px 12px 10px;color:var(--red);font-family:'Playfair Display',serif}

    header{
      background:linear-gradient(135deg,var(--red),#FF5252); color:#fff; padding:16px 12px;
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; text-align:center;
    }
    .header-left{display:flex;flex-direction:column;align-items:center;gap:6px;flex:1 1 100%}
    .logo-icon img{width:52px;height:52px;border-radius:12px;background:#fff;padding:4px;box-shadow:0 4px 12px rgba(255,255,255,.4)}
    .logo-text h1{font-family:'Playfair Display',serif;font-size:24px;margin:0;color:#fff;line-height:1.2}
    .logo-text .slogan{font-size:16px;margin-top:4px;color:#FFEAEA;font-weight:400}
    .header-right{display:flex;flex-direction:row;justify-content:center;align-items:center;gap:10px;width:100%}

    .signup-button,.login-button{
      border-radius:12px; padding:12px 14px; box-shadow:0 4px 12px rgba(0,0,0,.08);
      font-weight:600; font-size:14px; text-decoration:none;
      display:inline-flex; align-items:center; justify-content:center; gap:6px;
      min-height:44px; min-width:120px; border:1px solid transparent; transition:background .2s,transform .1s,box-shadow .2s; cursor:pointer;
    }
    .signup-button{background:#FFEBEE;color:var(--red);border-color:var(--red)}
    .login-button{background:var(--red);color:#fff}
    .signup-button:active,.login-button:active{transform:translateY(1px)}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;padding:0 12px 24px}
    .card{
      background:rgba(255,255,255,.75); border-radius:16px; padding:14px 10px; text-align:center;
      box-shadow:0 6px 12px rgba(0,0,0,.06); border:1px solid var(--light-red); transition:transform .15s;
      user-select:none; text-decoration:none; color:inherit; display:block; min-height:88px;
    }
    .card:active{transform:translateY(2px)}
    .card .emoji{font-size:22px;display:block}
    .card p{margin-top:8px;font-size:14px;font-weight:600}

    .bottom-nav{
      position:fixed; bottom:0; left:0; right:0; background:#fff; display:flex; justify-content:space-around; align-items:center;
      padding:8px 0 env(safe-area-inset-bottom,0px); box-shadow:0 -4px 12px rgba(0,0,0,.05);
      border-top-left-radius:16px; border-top-right-radius:16px; z-index:10; min-height:var(--bottom-nav-min-h);
    }
    .bottom-nav a{
      flex:1; text-align:center; font-size:22px; color:var(--red); text-decoration:none; padding:10px 0; transition:background .2s;
      border-radius:12px; min-height:44px; display:flex; align-items:center; justify-content:center; gap:6px;
    }
    .bottom-nav a:active{background:#FFEBEE}
/* Form chuy√™n gia */
.expert-dialog {
  max-width: 400px;
  width: 90%;
  padding: 24px;
  border-radius: 8px;
  background: #fff;
}

.expert-dialog .form-title {
  font-size: 1.4rem;
  font-weight: 600;
  margin-bottom: 8px;
  text-align: center;
}

.expert-dialog .form-subtitle {
  font-size: 0.95rem;
  color: #666;
  margin-bottom: 20px;
  text-align: center;
}

.expert-form .form-group {
  margin-bottom: 16px;
}

.expert-form label {
  display: block;
  font-weight: 500;
  margin-bottom: 6px;
}

.expert-form input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 0.95rem;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.expert-form input:focus {
  border-color: #C62828;
  box-shadow: 0 0 0 2px rgba(198, 40, 40, 0.15);
  outline: none;
}

.btn-primary.full-width {
  width: 100%;
  padding: 10px;
  font-size: 1rem;
  border-radius: 6px;
}
/* B·∫ÆT ƒê·∫¶U CH√àN - Con m·∫Øt ·∫©n/hi·ªán m·∫≠t kh·∫©u */
.password-wrapper {
  position: relative;
}

.password-wrapper input {
  padding-right: 40px;
}

.toggle-password {
  position: absolute;
  top: 50%;
  right: 12px;
  transform: translateY(-50%);
  cursor: pointer;
  color: #888;
  font-size: 1.1rem;
}

.toggle-password:hover {
  color: #C62828;
}
/* K·∫æT TH√öC CH√àN */



    /* Footer + consent + banner */
    footer.site-footer { margin: 24px 0 calc(var(--bottom-nav-pad) + 8px); padding: 16px 12px; color: #666; font-size: 13px; text-align: center; }
    .footer-links { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-bottom:6px; }
    .footer-links a { color:var(--red); font-weight:700; text-decoration:none; }
    .footer-links a:hover { text-decoration:underline; }
    .consent { display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:start; font-size:13px; color:#444; }
    .consent a { color:var(--red); font-weight:700; text-decoration:none; }
    .consent a:hover { text-decoration:underline; }
    .consent input[type="checkbox"] { margin-top:2px; width:18px; height:18px; accent-color:var(--red); }
    .consent-error { color:#B00020; font-size:12px; margin-top:4px; display:none; }
    .session-banner { display:none; background:#FFF0F1; border:1px solid #FFC1C4; border-radius:12px; padding:10px 12px; margin:0 12px 12px; color:#C62828; font-size:14px; }

    /* Overlay/dialog chung */
    .overlay{
      position:fixed; inset:0; background:rgba(15,15,15,.5); display:none; justify-content:center; align-items:center; z-index:999;
      padding:16px; backdrop-filter:blur(4px);
    }
    .overlay.active{display:flex}
    body.popup-active #main-content{filter:blur(4px); pointer-events:none}
    .dialog{
      background:#fff; padding:24px 20px 20px; border-radius:20px; width:100%; max-width:420px; position:relative;
      box-shadow:0 16px 40px rgba(0,0,0,.18); border:1px solid #F3F3F3; animation:popupIn .25s ease;
    }
    @keyframes popupIn{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
    .close-btn{
      position:absolute; top:12px; right:12px; width:40px; height:40px; background:#FFF; border:2px solid var(--red);
      border-radius:10px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer;
      box-shadow:0 2px 8px rgba(0,0,0,.08); transition:background .15s, box-shadow .15s, transform .05s;
    }
    .close-btn:hover{background:#FFEBEE}
    .close-btn:active{transform:translateY(1px)}
    .close-btn .x{font-size:18px; line-height:1; color:var(--red); font-weight:700}

    /* Popup 1: ch·ªçn vai tr√≤ */
    .role-title{margin:4px 0 8px; font-size:20px; color:var(--red); font-family:'Playfair Display',serif}
    .role-subtitle{margin:0 0 16px; font-size:14px; color:#666}
    .role-actions{display:grid; grid-template-columns:1fr; gap:10px; margin-top:8px}
    @media(min-width:420px){.role-actions{grid-template-columns:1fr 1fr}}
    .role-btn{
      width:100%; padding:12px; font-size:15px; font-weight:700; border-radius:12px; cursor:pointer; min-height:44px;
      display:inline-flex; align-items:center; justify-content:center; gap:8px; border:2px solid transparent;
      transition:background .15s, transform .05s, box-shadow .15s, border-color .15s;
    }
    .role-btn:active{transform:translateY(1px)}
    .btn-customer{background:#FFF7F8; color:var(--red); border-color:#F8B6BE}
    .btn-customer:hover{background:#FFEBEE}
    .btn-expert{background:var(--red); color:#fff; border-color:var(--red-dark)}
    .btn-expert:hover{background:var(--red-dark)}

    /* Popup 2: form ƒëƒÉng nh·∫≠p kh√°ch h√†ng */
    .form-title{margin:4px 0 12px; font-size:20px; color:var(--red); font-family:'Playfair Display',serif}
    .form-desc{margin:0 0 16px; font-size:14px; color:#666}
    .form{display:grid; gap:12px}
    .field{display:grid; gap:6px}
    .label{font-size:13px; color:#444; font-weight:600}
    .input{
      width:100%; padding:12px 12px; border:1.5px solid var(--field-bd); border-radius:var(--field-br); background:#fff;
      font-size:15px; outline:none; transition:border-color .15s, box-shadow .15s;
    }
    .input:focus{border-color:var(--red); box-shadow:0 0 0 3px rgba(198,40,40,.15)}
    .help{font-size:12px; color:#888}

    /* Autocomplete g·ª£i √Ω */
    .suggest { position:relative; }
    #locList { position:absolute; z-index:2; left:0; right:0; margin:4px 0 0; padding:6px; background:#fff; border:1px solid #eee; border-radius:10px; max-height:220px; overflow:auto; list-style:none; }

    /* Kh·ªëi action ƒë·ªãa ch·ªâ */
    .location-actions{
      display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between;
      gap:8px; margin-top:2px;
    }
    .btn-secondary{
      background:#FFF7F8; color:var(--red); border:2px solid #F8B6BE; border-radius:12px;
      padding:10px 12px; font-weight:700; font-size:14px; cursor:pointer; min-height:40px;
      transition:background .15s, transform .05s, border-color .15s;
    }
    .btn-secondary:hover{background:#FFEBEE}
    .btn-secondary:active{transform:translateY(1px)}
    .map-link{
      font-size:14px; color:var(--red); text-decoration:none; font-weight:700;
      padding:8px 10px; border-radius:10px; background:#FFF7F8; border:1px dashed #F8B6BE;
    }
    .map-link[aria-disabled="true"]{opacity:.6; pointer-events:none}

    /* Popup 3: ch·ªçn v·ªã tr√≠ tr√™n b·∫£n ƒë·ªì */
    .map-dialog .form-title{margin-bottom:8px}
    #pickMap{width:100%; height:340px; border-radius:12px; overflow:hidden; border:1px solid #eee}
    .map-actions{display:flex; gap:8px; margin-top:12px; justify-content:flex-end}
    .btn-outline{
      background:#fff; color:#444; border:2px solid #ddd; border-radius:12px; padding:10px 12px; font-weight:700; font-size:14px; cursor:pointer;
    }
    .btn-outline:hover{background:#f9f9f9}
    .btn-confirm{
      background:var(--red); color:#fff; border:none; border-radius:12px; padding:10px 14px; font-weight:700; font-size:14px; cursor:pointer;
    }
    .btn-confirm:hover{background:var(--red-dark)}

    .actions{display:grid; gap:10px; margin-top:6px}
    .btn-primary{
      background:var(--red); color:#fff; border:none; border-radius:12px; padding:12px; font-weight:700; font-size:15px; cursor:pointer;
      min-height:44px; transition:background .15s, transform .05s, box-shadow .15s;
    }
    .btn-primary:hover{background:var(--red-dark)}
    .btn-primary:active{transform:translateY(1px)}
    .note{font-size:12px; color:#777; text-align:center}

    @media(min-width:481px){
      .header-left{align-items:flex-start; text-align:left; flex:1 1 auto}
      .header-right{flex:0 0 auto; width:auto; flex-direction:column; gap:8px}
      .logo-text h1{font-size:26px} .logo-text .slogan{font-size:18px}
    }
    @media (prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important}}
  </style>
  <style>
   @keyframes shake {
   0%, 100% { transform: translateX(0); }
  20%, 60% { transform: translateX(-8px); }
  40%, 80% { transform: translateX(8px); }
   }
   .shake {
     animation: shake 0.5s;
   }
   </style>



</head>
<body>
  <div id="main-content">
    <header>
      <div class="header-left">
        <div class="logo-icon">
          <img src="images/icon-512.png" alt="Logo ·ªû ƒê√¢y C√≥ G√¨?" width="52" height="52" loading="eager" />
        </div>
        <div class="logo-text">
          <h1>·ªû ƒê√¢y C√≥ G√¨?</h1>
          <p class="slogan">K·∫øt n·ªëi y√™u th∆∞∆°ng</p>
        </div>
      </div>
      <div class="header-right">
        <a id="signupLink" href="javascript:void(0)" class="signup-button" aria-label="ƒêƒÉng k√Ω" onclick="openRegisterDialog()">
  <span class="emoji" aria-hidden="true">üìù</span><span>ƒêƒÉng k√Ω</span>
</a>

        <button type="button" class="login-button" id="loginBtn" aria-haspopup="dialog" aria-controls="overlay" aria-expanded="false">
          <span class="emoji" aria-hidden="true">üîê</span><span>ƒêƒÉng nh·∫≠p</span>
        </button>
      </div>
    </header>

    <!-- Section h·ªì s∆° c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c ch√®n ngay d∆∞·ªõi header b·∫±ng JS khi ƒëƒÉng nh·∫≠p -->

    <section>
      <h2>D·ªãch v·ª• y√™u th√≠ch</h2>
      <div class="grid">
        <a href="bando.html" class="card" aria-label="ƒê·∫∑t xe"><span class="emoji" aria-hidden="true">üí∏</span><p>ƒê·∫∑t xe</p></a>
        <a href="trasua.html" class="card" aria-label="ƒê·∫∑t n∆∞·ªõc"><span class="emoji" aria-hidden="true">üßæ</span><p>ƒê·∫∑t n∆∞·ªõc</p></a>
        <a href="lamdep.html" class="card" aria-label="L√†m ƒë·∫πp v√† S·ª©c kh·ªèe"><span class="emoji" aria-hidden="true">üì∑</span><p>L√†m ƒë·∫πp - S·ª©c kh·ªèe</p></a>
        <a href="donTre.html" class="card" aria-label="ƒê√≥n tr·∫ª"><span class="emoji" aria-hidden="true">üí≥</span><p>ƒê√≥n tr·∫ª</p></a>
        <a href="vanchuyen.html" class="card" aria-label="V·∫≠n chuy·ªÉn"><span class="emoji" aria-hidden="true">üê∑</span><p>V·∫≠n chuy·ªÉn</p></a>
        <a href="laodong.html" class="card" aria-label="Giao h√†ng"><span class="emoji" aria-hidden="true">üõçÔ∏è</span><p>Giao h√†ng</p></a>
        <a href="laodong.html" class="card" aria-label="T√¨m vi·ªác l√†m"><span class="emoji" aria-hidden="true">üõçÔ∏è</span><p>T√¨m vi·ªác l√†m</p></a>
        <a href="laodong.html" class="card" aria-label="Rao v·∫∑t"><span class="emoji" aria-hidden="true">üõçÔ∏è</span><p>Rao v·∫∑t</p></a>
        <a href="laodong.html" class="card" aria-label="M·ªü c·ª≠a h√†ng"><span class="emoji" aria-hidden="true">üõçÔ∏è</span><p>M·ªü c·ª≠a h√†ng</p></a>
      </div>
    </section>

    <section>
      <h2>Tr√† s·ªØa</h2>
      <div class="grid">
        <a href="trasua1.html" class="card" aria-label="Tr√† s·ªØa 1"><span class="emoji" aria-hidden="true">üìä</span><p>Tr√† s·ªØa 1</p></a>
        <a href="trasua2.html" class="card" aria-label="Tr√† s·ªØa 2"><span class="emoji" aria-hidden="true">ü™ô</span><p>Tr√† s·ªØa 2</p></a>
        <a href="trasua3.html" class="card" aria-label="Tr√† s·ªØa 3"><span class="emoji" aria-hidden="true">üìö</span><p>Tr√† s·ªØa 3</p></a>
        <a href="trasua4.html" class="card" aria-label="Tr√† s·ªØa 4"><span class="emoji" aria-hidden="true">üõ°Ô∏è</span><p>Tr√† s·ªØa 4</p></a>
        <a href="trasua5.html" class="card" aria-label="Tr√† s·ªØa 5"><span class="emoji" aria-hidden="true">üêû</span><p>Tr√† s·ªØa 5</p></a>
        <a href="trasua6.html" class="card" aria-label="Tr√† s·ªØa 6"><span class="emoji" aria-hidden="true">üìà</span><p>Tr√† s·ªØa 6</p></a>
        <a href="trasua7.html" class="card" aria-label="Tr√† s·ªØa 7"><span class="emoji" aria-hidden="true">üí∞</span><p>Tr√† s·ªØa 7</p></a>
        <a href="trasua8.html" class="card" aria-label="Tr√† s·ªØa 8"><span class="emoji" aria-hidden="true">üì±</span><p>Tr√† s·ªØa 8</p></a>
        <a href="trasua9.html" class="card" aria-label="Tr√† s·ªØa 9"><span class="emoji" aria-hidden="true">‚úàÔ∏è</span><p>Tr√† s·ªØa 9</p></a>
        <a href="trasua10.html" class="card" aria-label="Tr√† s·ªØa 10"><span class="emoji" aria-hidden="true">üéì</span><p>Tr√† s·ªØa 10</p></a>
        <a href="trasua11.html" class="card" aria-label="Tr√† s·ªØa 11"><span class="emoji" aria-hidden="true">‚ù§Ô∏è</span><p>Tr√† s·ªØa 11</p></a>
        <a href="trasua12.html" class="card" aria-label="Tr√† s·ªØa 12"><span class="emoji" aria-hidden="true">üí¨</span><p>Tr√† s·ªØa 12</p></a>
      </div>
    </section>

    <section>
      <h2>Tr√† tr√°i c√¢y</h2>
      <div class="grid">
        <a href="tratraicay1.html" class="card" aria-label="Tr√† tr√°i c√¢y 1"><span class="emoji" aria-hidden="true">üçì</span><p>Tr√† tr√°i c√¢y 1</p></a>
        <a href="tratraicay2.html" class="card" aria-label="Tr√† tr√°i c√¢y 2"><span class="emoji" aria-hidden="true">üçç</span><p>Tr√† tr√°i c√¢y 2</p></a>
        <a href="tratraicay3.html" class="card" aria-label="Tr√† tr√°i c√¢y 3"><span class="emoji" aria-hidden="true">üçë</span><p>Tr√† tr√°i c√¢y 3</p></a>
        <a href="tratraicay4.html" class="card" aria-label="Tr√† tr√°i c√¢y 4"><span class="emoji" aria-hidden="true">üçã</span><p>Tr√† tr√°i c√¢y 4</p></a>
        <a href="tratraicay5.html" class="card" aria-label="Tr√† tr√°i c√¢y 5"><span class="emoji" aria-hidden="true">üçá</span><p>Tr√† tr√°i c√¢y 5</p></a>
        <a href="tratraicay6.html" class="card" aria-label="Tr√† tr√°i c√¢y 6"><span class="emoji" aria-hidden="true">ü•≠</span><p>Tr√† tr√°i c√¢y 6</p></a>
        <a href="tratraicay7.html" class="card" aria-label="Tr√† tr√°i c√¢y 7"><span class="emoji" aria-hidden="true">üçâ</span><p>Tr√† tr√°i c√¢y 7</p></a>
        <a href="tratraicay8.html" class="card" aria-label="Tr√† tr√°i c√¢y 8"><span class="emoji" aria-hidden="true">üçä</span><p>Tr√† tr√°i c√¢y 8</p></a>
        <a href="tratraicay9.html" class="card" aria-label="Tr√† tr√°i c√¢y 9"><span class="emoji" aria-hidden="true">üçè</span><p>Tr√† tr√°i c√¢y 9</p></a>
        <a href="tratraicay10.html" class="card" aria-label="Tr√† tr√°i c√¢y 10"><span class="emoji" aria-hidden="true">üçà</span><p>Tr√† tr√°i c√¢y 10</p></a>
        <a href="tratraicay11.html" class="card" aria-label="Tr√† tr√°i c√¢y 11"><span class="emoji" aria-hidden="true">üçí</span><p>Tr√† tr√°i c√¢y 11</p></a>
        <a href="tratraicay12.html" class="card" aria-label="Tr√† tr√°i c√¢y 12"><span class="emoji" aria-hidden="true">ü•ù</span><p>Tr√† tr√°i c√¢y 12</p></a>
      </div>
    </section>

    <!-- Footer -->
    <footer class="site-footer" aria-label="Ch√¢n trang">
      <div class="footer-links">
        <a href="terms.html">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a>
        <a href="privacy.html">Ch√≠nh s√°ch quy·ªÅn ri√™ng t∆∞</a>
      </div>
      <div>¬© 2025 ·ªû ƒê√¢y C√≥ G√¨?</div>
    </footer>

    <nav class="bottom-nav" aria-label="ƒêi·ªÅu h∆∞·ªõng ch√≠nh" id="bottomNav">
      <a href="index.html" aria-label="Trang ch·ªß"><span class="emoji" aria-hidden="true">üè†</span></a>
      <a href="thongbao.html" aria-label="Th√¥ng b√°o"><span class="emoji" aria-hidden="true">üîî</span></a>
      <a href="lienhe.html" aria-label="Li√™n h·ªá"><span class="emoji" aria-hidden="true">üìû</span></a>
      <a href="taikhoan.html" aria-label="T√†i kho·∫£n"><span class="emoji" aria-hidden="true">üë§</span></a>
    </nav>
  </div>
  <!-- Overlay + Dialogs -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-labelledby="dialogTitle" aria-describedby="dialogDesc">
    <!-- Dialog 1: Ch·ªçn vai tr√≤ -->
    <div class="dialog" id="roleBox" hidden>
      <button class="close-btn" type="button" id="closeRole" aria-label="ƒê√≥ng c·ª≠a s·ªï">
        <span class="x" aria-hidden="true">‚úï</span>
      </button>
      <h2 class="role-title" id="dialogTitle">Ch·ªçn vai tr√≤ ƒë·ªÉ ti·∫øp t·ª•c</h2>
      <p class="role-subtitle" id="dialogDesc">Vui l√≤ng ch·ªçn vai tr√≤ ph√π h·ª£p ƒë·ªÉ ch√∫ng t√¥i ƒëi·ªÅu h∆∞·ªõng b·∫°n ƒë·∫øn ƒë√∫ng n∆°i.</p>
      <div class="role-actions">
        <button type="button" id="roleCustomer" class="role-btn btn-customer" aria-label="B·∫°n l√† kh√°ch h√†ng">
          <span aria-hidden="true">üë§</span> B·∫°n l√† kh√°ch h√†ng
        </button>
        <button type="button" id="roleExpert" class="role-btn btn-expert" aria-label="B·∫°n l√† chuy√™n gia">
          <span aria-hidden="true">üß†</span> B·∫°n l√† chuy√™n gia
        </button>
      </div>
      <p class="help" style="text-align:center;margin-top:10px;">
        Khi ti·∫øp t·ª•c, b·∫°n ch·∫•p nh·∫≠n
        <a href="terms.html" target="_blank" rel="noopener">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a> v√†
        <a href="privacy.html" target="_blank" rel="noopener">Ch√≠nh s√°ch quy·ªÅn ri√™ng t∆∞</a>.
      </p>
    </div>

    <!-- Dialog 2: ƒêƒÉng nh·∫≠p kh√°ch h√†ng -->
    <div class="dialog" id="customerBox" hidden aria-labelledby="customerTitle" aria-describedby="customerDesc">
      <button class="close-btn" type="button" id="closeCustomer" aria-label="ƒê√≥ng c·ª≠a s·ªï">
        <span class="x" aria-hidden="true">‚úï</span>
      </button>
      <h2 class="form-title" id="customerTitle">ƒêƒÉng nh·∫≠p kh√°ch h√†ng</h2>
      <p class="form-desc" id="customerDesc">Nh·∫≠p th√¥ng tin c·ªßa b·∫°n ƒë·ªÉ ti·∫øp t·ª•c s·ª≠ d·ª•ng d·ªãch v·ª•.</p>

      <!-- Autocomplete g·ª£i √Ω ƒë·ªãa ch·ªâ -->
      <div class="field">
        <label class="label" for="locSearch">T√¨m nhanh ƒë·ªãa ch·ªâ</label>
        <input class="input" type="text" id="locSearch" placeholder="Nh·∫≠p t√™n ƒë∆∞·ªùng, ph∆∞·ªùng, qu·∫≠n, th√†nh ph·ªë..." autocomplete="off" />
        <div id="locSuggest" class="suggest" style="display:none;">
          <ul id="locList"></ul>
        </div>
        <span class="help">Ch·ªçn m·ªôt g·ª£i √Ω ƒë·ªÉ ƒëi·ªÅn ƒë·ªãa ch·ªâ ngay.</span>
      </div>

      <form class="form" id="customerForm" novalidate>
        <div class="field">
          <label class="label" for="cusName">T√™n kh√°ch h√†ng</label>
          <input class="input" type="text" id="cusName" name="name" placeholder="Nguy·ªÖn VƒÉn A" autocomplete="name" required />
        </div>

        <div class="field">
          <label class="label" for="cusPhone">S·ªë ƒëi·ªán tho·∫°i</label>
          <input class="input" type="tel" id="cusPhone" ... pattern="^0[0-9]{9}$" required />
          <span class="help">Nh·∫≠p s·ªë di ƒë·ªông Vi·ªát Nam, b·∫Øt ƒë·∫ßu b·∫±ng 0.</span>
        </div>

        <div class="field">
          <label class="label" for="cusLocation">V·ªã tr√≠</label>
          <input class="input" type="text" id="cusLocation" name="location" placeholder="Ph∆∞·ªùng/Qu·∫≠n/Th√†nh ph·ªë" autocomplete="street-address" required />
          <div class="location-actions">
            <button type="button" id="getLocationBtn" class="btn-secondary">üìç L·∫•y ƒë·ªãa ch·ªâ hi·ªán t·∫°i</button>
            <a id="viewMapLink" class="map-link" href="#" target="_blank" rel="noopener" aria-disabled="true">v·ªã tr√≠ c·ªßa b·∫°n</a>
            <button type="button" id="pickOnMapBtn" class="btn-secondary">üó∫Ô∏è Ch·ªçn tr√™n b·∫£n ƒë·ªì</button>
          </div>
          <span class="help" id="locHelp">Cho ph√©p quy·ªÅn v·ªã tr√≠ ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn ƒë·ªãa ch·ªâ, ho·∫∑c ch·ªçn tr√™n b·∫£n ƒë·ªì.</span>
        </div>



        <!-- ƒê·ªìng √Ω ƒëi·ªÅu kho·∫£n & quy·ªÅn ri√™ng t∆∞ -->
        <div class="consent">
          <input id="consentCustomer" type="checkbox" required aria-describedby="consentCustomerErr">
          <label for="consentCustomer">
            T√¥i ƒë·ªìng √Ω <a href="terms.html" target="_blank" rel="noopener">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a> v√†
            <a href="privacy.html" target="_blank" rel="noopener">Ch√≠nh s√°ch quy·ªÅn ri√™ng t∆∞</a>.
          </label>
        </div>
        <div id="consentCustomerErr" class="consent-error">B·∫°n c·∫ßn ƒë·ªìng √Ω ƒêi·ªÅu kho·∫£n v√† Ch√≠nh s√°ch ƒë·ªÉ ti·∫øp t·ª•c.</div>

        <div class="actions">
          <button type="submit" class="btn-primary" id="customerLoginBtn">ƒêƒÉng nh·∫≠p</button>
          <div class="note">B·∫±ng c√°ch ti·∫øp t·ª•c, b·∫°n ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu kho·∫£n v√† ch√≠nh s√°ch c·ªßa ch√∫ng t√¥i.</div>
        </div>
      </form>
    </div>

<!-- Dialog: ƒêƒÉng nh·∫≠p chuy√™n gia -->
<div class="dialog expert-dialog" id="expertBox" hidden aria-labelledby="expertTitle" aria-describedby="expertDesc">
  <button class="close-btn" type="button" id="closeExpert" aria-label="ƒê√≥ng c·ª≠a s·ªï">
    <span class="x" aria-hidden="true">‚úï</span>
  </button>
  <h2 class="form-title" id="expertTitle">ƒêƒÉng nh·∫≠p chuy√™n gia</h2>
  <p id="expertDesc" class="form-subtitle">Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i v√† m·∫≠t kh·∫©u ƒë·ªÉ ti·∫øp t·ª•c.</p>
  <form id="expertForm" class="expert-form">
    <div class="form-group">
      <label for="expertPhone">S·ªë ƒëi·ªán tho·∫°i</label>
      <input type="tel" id="expertPhone" name="expertPhone" pattern="^0[0-9]{9}$" required placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" />
    </div>

    <div class="form-group">
      <label for="expertPassword">M·∫≠t kh·∫©u</label>
      <div class="password-wrapper">
  <input type="password" id="expertPassword" name="expertPassword" required placeholder="Nh·∫≠p m·∫≠t kh·∫©u" />
  <span class="toggle-password" aria-label="Hi·ªán/·∫©n m·∫≠t kh·∫©u">
    <i class="fa fa-eye"></i>
  </span>
</div>

    </div>

    <button type="submit" class="btn-primary full-width">ƒêƒÉng nh·∫≠p</button>
  </form>
</div>
<!-- üîΩ POPUP ƒêƒÇNG K√ù -->
<div class="dialog" id="registerDialog" hidden>
  <!-- N√∫t ƒë√≥ng gi·ªëng c√°c popup kh√°c -->
  <button class="close-btn" type="button" onclick="closeRegisterDialog()" aria-label="ƒê√≥ng c·ª≠a s·ªï">
    <span class="x" aria-hidden="true">‚úï</span>
  </button>

  <h2 class="form-title">ƒêƒÉng k√Ω d·ªãch v·ª•</h2>

  <form id="registerForm">
    <input type="text" name="fullname" placeholder="H·ªç v√† t√™n" required>
    <input type="email" name="email" placeholder="Email" required>
    <input type="tel" name="phone" placeholder="S·ªë ƒëi·ªán tho·∫°i" required>
    <input type="password" name="password" placeholder="M·∫≠t kh·∫©u" required>

    <label for="job"></label>
    <select id="job" name="job" required>
      <option value="">-- Ch·ªçn ng√†nh ngh·ªÅ --</option>
      <option value="driver">T√†i x·∫ø</option>
      <option value="shop">M·ªü c·ª≠a h√†ng</option>
      <option value="electrician">Th·ª£ ƒëi·ªán - n∆∞·ªõc</option>
      <option value="mechanic">Th·ª£ s·ª≠a xe</option>
      <option value="cleaning">D·ªçn v·ªá sinh / gi√∫p vi·ªác</option>
      <option value="gardening">L√†m v∆∞·ªùn / chƒÉm c√¢y</option>
      <option value="delivery">Giao h√†ng / v·∫≠n chuy·ªÉn</option>
      <option value="photography">Ch·ª•p ·∫£nh - quay phim</option>
      <option value="it">S·ª≠a m√°y t√≠nh / ƒëi·ªán tho·∫°i</option>
      <option value="other">Ng√†nh kh√°c</option>
    </select>

    <!-- Tr∆∞·ªùng b·ªï sung s·∫Ω ƒë∆∞·ª£c JS ch√®n v√†o ƒë√¢y -->
    <div id="extraFields"></div>

    <button type="submit" class="btn-primary full-width">ƒêƒÉng k√Ω</button>
  </form>
</div>
<!-- üîº H·∫æT POPUP -->



    <!-- Dialog 3: Ch·ªçn v·ªã tr√≠ tr√™n b·∫£n ƒë·ªì -->
    <div class="dialog map-dialog" id="mapBox" hidden aria-labelledby="mapTitle">
      <button class="close-btn" type="button" id="closeMap" aria-label="ƒê√≥ng b·∫£n ƒë·ªì">
        <span class="x" aria-hidden="true">‚úï</span>
      </button>
      <h2 class="form-title" id="mapTitle">Ch·ªçn v·ªã tr√≠ tr√™n b·∫£n ƒë·ªì</h2>
      <div id="pickMap" role="application" aria-label="B·∫£n ƒë·ªì ch·ªçn v·ªã tr√≠"></div>
      <div class="map-actions">
        <button type="button" class="btn-outline" id="mapMyLoc">üìç ƒê∆∞a ghim v·ªÅ v·ªã tr√≠ c·ªßa t√¥i</button>
        <button type="button" class="btn-confirm" id="mapConfirm">X√°c nh·∫≠n v·ªã tr√≠</button>
      </div>
      <div class="help" id="mapHelp" style="margin-top:6px;">K√©o ghim ƒë·∫øn v·ªã tr√≠ mong mu·ªën, sau ƒë√≥ b·∫•m X√°c nh·∫≠n.</div>
    </div>
  </div>
<!-- Popup th√¥ng b√°o ƒëƒÉng nh·∫≠p -->
<div class="overlay" id="loginNoticeOverlay" style="display:none;">
  <div class="dialog">
    <button class="close-btn" type="button" id="closeLoginNotice" aria-label="ƒê√≥ng th√¥ng b√°o">
      <span class="x" aria-hidden="true">‚úï</span>
    </button>
    <h2 class="form-title">Qu√Ω kh√°ch vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c</h2>
    <div class="actions" style="margin-top:16px;">
      <button type="button" class="btn-primary" id="loginNoticeBtn">ƒêƒÉng nh·∫≠p</button>
    </div>
  </div>
</div>



  <!-- Scripts: core behaviors, login, profile render, session ping -->
  <script>
    // URLs
    const WEB_APP_MAIN = 'https://script.google.com/macros/s/AKfycbwfeWkWWGllDaAD0ZhARdJ1UvOYwDalBF1rYUKWeD3178lqEB5g5qTv0aIBFu3RqW4Z/exec'; // app ch√≠nh
    const WEB_APP_INFO = 'https://script.google.com/macros/s/AKfycbz89ganqrguJnrd9rbJQawgkhfGNQMuP3R1mE1Y774_J3_30c-QGGkDfYqWhR90lLoW/exec'; // app th√¥ng tin KH (fetch_by_phone)

    // Elements
    const bottomNav = document.getElementById('bottomNav');
    const overlay = document.getElementById('overlay');
    const roleBox = document.getElementById('roleBox');
    const customerBox = document.getElementById('customerBox');
    const mapBox = document.getElementById('mapBox');

    const loginBtn = document.getElementById('loginBtn');
    const signupLink = document.getElementById('signupLink');
    const closeRole = document.getElementById('closeRole');
    const closeCustomer = document.getElementById('closeCustomer');
    const closeMap = document.getElementById('closeMap');

    const roleCustomerBtn = document.getElementById('roleCustomer');
    const roleExpertBtn = document.getElementById('roleExpert');

    const customerForm = document.getElementById('customerForm');
    const cusName = document.getElementById('cusName');
    const cusPhone = document.getElementById('cusPhone');
    const cusLocation = document.getElementById('cusLocation');
    const locHelp = document.getElementById('locHelp');

    const getLocationBtn = document.getElementById('getLocationBtn');
    const pickOnMapBtn = document.getElementById('pickOnMapBtn');
    const viewMapLink = document.getElementById('viewMapLink');

    const locSearch = document.getElementById('locSearch');
    const locSuggest = document.getElementById('locSuggest');
    const locList = document.getElementById('locList');

    const consentCustomer = document.getElementById('consentCustomer');
    const consentCustomerErr = document.getElementById('consentCustomerErr');
    const customerLoginBtn = document.getElementById('customerLoginBtn');
// üîΩ JS POPUP ƒêƒÇNG K√ù
function openRegisterDialog() {
  // ƒê√≥ng c√°c popup kh√°c
  roleBox.hidden = true;
  customerBox.hidden = true;
  expertBox.hidden = true;
  mapBox.hidden = true;

  // M·ªü overlay v√† popup ƒëƒÉng k√Ω
  overlay.classList.add('active');
  document.body.classList.add('popup-active');
  document.getElementById('registerDialog').hidden = false;

  // Focus v√†o √¥ ƒë·∫ßu ti√™n n·∫øu mu·ªën
  setTimeout(() => {
    const firstInput = document.querySelector('#registerDialog input[name="fullname"]');
    if (firstInput) firstInput.focus();
  }, 0);
}

function closeRegisterDialog() {
  document.getElementById('registerDialog').hidden = true;
  overlay.classList.remove('active');
  document.body.classList.remove('popup-active');
}


document.getElementById('job').addEventListener('change', function() {
  const extraFields = document.getElementById('extraFields');
  extraFields.innerHTML = '';

  switch (this.value) {
    case 'driver':
      extraFields.innerHTML = `
        <label></label>
        <select name="vehicleType" required>
          <option value="">-- Ch·ªçn lo·∫°i ph∆∞∆°ng ti·ªán --</option>
          <option value="car">Xe √¥ t√¥</option>
          <option value="motorbike">Xe m√°y</option>
          <option value="truck">V·∫≠n t·∫£i</option>
        </select>

        <label></label>
        <select name="licenseType" required>
          <option value="">-- Ch·ªçn lo·∫°i b·∫±ng l√°i --</option>
          <option value="B1">B1</option>
          <option value="B2">B2</option>
          <option value="C">C</option>
          <option value="A1">A1</option>
          <option value="A2">A2</option>
          <option value="none">Hi·ªán ch∆∞a c√≥ b·∫±ng l√°i</option>
        </select>

        <input type="text" name="expertName" placeholder="T√™n chuy√™n gia" required>
        <input type="text" name="cccd" placeholder="S·ªë CCCD" required>
        ${addressFields()}
      `;
      break;

    case 'shop':
      extraFields.innerHTML = `
        <input type="text" name="shopName" placeholder="T√™n c·ª≠a h√†ng" required>
        <input type="text" name="ownerName" placeholder="T√™n ch·ªß c·ª≠a h√†ng" required>
        <input type="text" name="cccd" placeholder="S·ªë CCCD" required>
        ${addressFields()}
      `;
      break;

    case 'electrician':
    case 'mechanic':
    case 'cleaning':
    case 'gardening':
    case 'delivery':
    case 'photography':
    case 'it':
      extraFields.innerHTML = `
        <input type="text" name="serviceName" placeholder="T√™n d·ªãch v·ª• / chuy√™n m√¥n" required>
        <input type="number" name="experience" placeholder="S·ªë nƒÉm kinh nghi·ªám" required>
        ${addressFields()}
      `;
      break;

    case 'other':
      extraFields.innerHTML = `
        <input type="text" name="profession" placeholder="Ng√†nh ngh·ªÅ c·ª• th·ªÉ" required>
        <textarea name="description" placeholder="M√¥ t·∫£ c√¥ng vi·ªác"></textarea>
        ${addressFields()}
      `;
      break;
  }
});
function addressFields() {
  return `
    <div style="margin-top: 12px;">
      <label for="currentAddress" style="display: block; margin-bottom: 6px;">Ch·ªó ·ªü hi·ªán t·∫°i</label>

      <input type="text" id="currentAddress" name="currentAddress"
        placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ho·∫∑c b·∫•m n√∫t ƒë·ªÉ l·∫•y v·ªã tr√≠">

      <div class="location-buttons">
        <button type="button" class="btn-secondary" onclick="getCurrentLocation()">üìç L·∫•y v·ªã tr√≠ hi·ªán t·∫°i</button>
        <button type="button" class="btn-secondary" onclick="openMapPickerForRegister()">üó∫Ô∏è Ch·ªçn tr√™n b·∫£n ƒë·ªì</button>
      </div>

      <a id="registerMapReviewLink" class="map-link" href="#" target="_blank" rel="noopener" aria-disabled="true"
         style="display:inline-block;margin-top:8px;">üîé Xem l·∫°i v·ªã tr√≠ tr√™n Google Maps</a>
    </div>
  `;
}


function openMapPickerForRegister() {
  mapTargetInput = document.getElementById('currentAddress'); // Ghi nh·ªõ input ƒë√≠ch
  document.getElementById('registerDialog').hidden = true;    // ·∫®n popup ƒëƒÉng k√Ω
  showMapDialog();                                             // Hi·ªÉn th·ªã b·∫£n ƒë·ªì
  initMapIfNeeded();                                           // Kh·ªüi t·∫°o n·∫øu ch∆∞a c√≥
  setTimeout(() => map && map.invalidateSize(), 50);           // Fix hi·ªÉn th·ªã map
}



async function getCurrentLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(async function(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;

      // Reverse geocode
      const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
      const data = await res.json();

      const input = document.getElementById('currentAddress');
      if (input) input.value = data.display_name || `${lat}, ${lon}`;

      // C·∫≠p nh·∫≠t link xem l·∫°i v·ªã tr√≠
      updateRegisterMapReviewLink(lat, lon);
    }, function(error) {
      alert('Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠: ' + error.message);
    });
  } else {
    alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.');
  }
}


// üîº H·∫æT JS POPUP


    // Anti-cache for signup
    // Anti-cache for signup (b·ªè qua khi href l√† javascript ƒë·ªÉ d√πng popup)
if (signupLink) {
  signupLink.addEventListener('click', function (e) {
    if (this.href.startsWith('javascript')) return; // popup: kh√¥ng ch·ªëng cache
    const url = new URL(this.href, location.origin);
    url.searchParams.set('v', Date.now().toString());
    this.href = url.toString();
  });
}


    // Overlay open/close
    function openOverlay(){
      overlay.classList.add('active');
      document.body.classList.add('popup-active');
      loginBtn.setAttribute('aria-expanded','true');
      showRoleDialog();
      document.addEventListener('keydown', handleKeydown);
    }
    function closeOverlay(){
      overlay.classList.remove('active');
      document.body.classList.remove('popup-active');
      loginBtn.setAttribute('aria-expanded','false');
      loginBtn.focus();
      document.removeEventListener('keydown', handleKeydown);
      roleBox.hidden = true; customerBox.hidden = true; mapBox.hidden = true;
    }

    // Show dialogs
    function showRoleDialog(){
      roleBox.hidden = false; customerBox.hidden = true; mapBox.hidden = true;
      setTimeout(()=>roleCustomerBtn.focus(),0);
    }
    function showCustomerDialog(){
      roleBox.hidden = true; customerBox.hidden = false; mapBox.hidden = true;
      setTimeout(()=>cusName.focus(),0);
    }
    function showMapDialog(){
      roleBox.hidden = true; customerBox.hidden = true; mapBox.hidden = false;
      setTimeout(()=>document.getElementById('mapTitle').focus?.(), 0);
    }

    // Focus trap
    function handleKeydown(e){
      if(e.key === 'Escape'){ closeOverlay(); return; }
      if(e.key !== 'Tab') return;
      const scope = !roleBox.hidden ? roleBox : (!customerBox.hidden ? customerBox : mapBox);
      const selectors = 'a[href],area[href],button:not([disabled]),input:not([disabled]),select:not([disabled]),textarea:not([disabled]),[tabindex]:not([tabindex="-1"])';
      const focusables = Array.from(scope.querySelectorAll(selectors)).filter(el => el.offsetParent !== null);
      if(!focusables.length) return;
      const first = focusables[0], last = focusables[focusables.length-1];
      if(e.shiftKey && document.activeElement === first){ last.focus(); e.preventDefault(); }
      else if(!e.shiftKey && document.activeElement === last){ first.focus(); e.preventDefault(); }
    }

    // Bind overlay/dialog
    loginBtn.addEventListener('click', openOverlay);
    closeRole.addEventListener('click', closeOverlay);
    closeCustomer.addEventListener('click', closeOverlay);
    closeMap.addEventListener('click', () => {
  mapBox.hidden = true;
  if (mapTargetInput && mapTargetInput.id === 'currentAddress') {
    document.getElementById('registerDialog').hidden = false;
  } else {
    showCustomerDialog();
  }
});

    overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closeOverlay(); });

    roleCustomerBtn.addEventListener('click', showCustomerDialog);




// M·ªü form ƒëƒÉng nh·∫≠p chuy√™n gia
const expertBox = document.getElementById('expertBox');
const closeExpertBtn = document.getElementById('closeExpert');
const expertPhone = document.getElementById('expertPhone');

roleExpertBtn.addEventListener('click', () => {
  roleBox.hidden = true;
  customerBox.hidden = true;
  expertBox.hidden = false;
  setTimeout(() => expertPhone.focus(), 100);
});

closeExpertBtn.addEventListener('click', () => {
  expertBox.hidden = true;
  overlay.classList.remove('active');
  document.body.classList.remove('popup-active');
});

// X·ª≠ l√Ω submit form chuy√™n gia
document.getElementById('expertForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const phone = expertPhone.value.trim();
  const password = document.getElementById('expertPassword').value.trim();
  console.log('ƒêƒÉng nh·∫≠p chuy√™n gia:', phone, password);
  // TODO: G·ªçi API ƒëƒÉng nh·∫≠p chuy√™n gia t·∫°i ƒë√¢y
});


    // Consent hide error
    consentCustomer.addEventListener('change', ()=>{
      if(consentCustomer.checked) consentCustomerErr.style.display = 'none';
    });

    // Utils
    function ensureDeviceId(){
      let id = localStorage.getItem('odcg_device_id');
      if(!id){
        id = (crypto.randomUUID ? crypto.randomUUID() : ('dev-' + Date.now() + '-' + Math.random()));
        localStorage.setItem('odcg_device_id', id);
      }
      return id;
    }
    async function postFormJSON(url, params){
      const res = await fetch(url, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
        body: new URLSearchParams(params)
      });
      const text = await res.text();
      try { return JSON.parse(text); } catch { return { ok:false, message:text }; }
    }

    // Render profile block right under header and toggle auth buttons
    function insertProfileSection(element) {
      const main = document.getElementById('main-content');
      const afterHeader = document.querySelector('header').nextElementSibling;
      main.insertBefore(element, afterHeader || main.firstChild);
    }
    function setAuthButtonsVisibility(isLoggedIn) {
      const login = document.getElementById('loginBtn');
      const signup = document.getElementById('signupLink');
      if (login) login.style.display = isLoggedIn ? 'none' : '';
      if (signup) signup.style.display = '';
    }
    function showSessionBannerUI(message) {
      const banner = document.getElementById('sessionBanner');
      const msg = document.getElementById('sessionBannerMsg');
      if (!banner || !msg) return;
      if (!message) { banner.style.display = 'none'; msg.textContent = ''; return; }
      msg.textContent = message;
      banner.style.display = 'block';
    }
function updateRegisterMapReviewLink(lat, lng) {
  const a = document.getElementById('registerMapReviewLink');
  if (!a) return;
  if (lat != null && lng != null) {
    a.href = `https://maps.google.com/?q=${lat},${lng}`;
    a.removeAttribute('aria-disabled');
  } else {
    a.href = '#';
    a.setAttribute('aria-disabled', 'true');
  }
}


    // Render 3 tr∆∞·ªùng + link "v·ªã tr√≠ c·ªßa b·∫°n" (∆∞u ti√™n mapUrl) + Logout
    function renderBasicCustomerInfo({ name, phone, location, mapUrl }) {
      let box = document.getElementById('customerBasic');
      if (!box) {
        box = document.createElement('section');
        box.id = 'customerBasic';
        box.innerHTML = `
          <div class="session-banner" id="sessionBanner">
            <strong>C·∫£nh b√°o:</strong> <span id="sessionBannerMsg"></span>
          </div>
          <h2>H·ªì s∆° c·ªßa b·∫°n</h2>
          <div class="card">
            <p><strong>T√™n:</strong> <span id="basicName"></span></p>
            <p><strong>SƒêT:</strong> <span id="basicPhone"></span></p>
            <p><strong>ƒê·ªãa ch·ªâ:</strong> 
              <span id="basicLoc"></span>
              <a id="basicMap" target="_blank" rel="noopener">v·ªã tr√≠ c·ªßa b·∫°n</a>
            </p>
            <div class="location-actions" style="margin-top:8px;">
              <button type="button" id="btnLogout" class="btn-secondary">üö™ ƒêƒÉng xu·∫•t</button>
            </div>
          </div>
        `;
        insertProfileSection(box);
      }
      document.getElementById('basicName').textContent = name || '';
      document.getElementById('basicPhone').textContent = phone || '';
      document.getElementById('basicLoc').textContent = location || '';

      const map = document.getElementById('basicMap');
      if (mapUrl) {
        map.href = mapUrl;
        map.style.display = '';
      } else if (location) {
        map.href = `https://maps.google.com/?q=${encodeURIComponent(location)}`;
        map.style.display = '';
      } else {
        map.href = '#';
        map.style.display = 'none';
      }

      const btnLogout = document.getElementById('btnLogout');
      if (btnLogout) btnLogout.onclick = apiLogout;

      setAuthButtonsVisibility(true);
    }
    function removeBasicCustomerInfo() {
      const box = document.getElementById('customerBasic');
      if (box && box.parentNode) box.parentNode.removeChild(box);
      setAuthButtonsVisibility(false);
    }

    // WEB APP INFO: l·∫•y 3 tr∆∞·ªùng theo SƒêT (tr·∫£ { ok, customer: {name, phone, location, mapUrl} })
    async function fetchCustomerInfoByPhone(phone) {
      return postFormJSON(WEB_APP_INFO, { action:'fetch_by_phone', phone });
    }

    // LOGIN: ch·∫•p nh·∫≠n JSON ho·∫∑c TEXT, ƒë√≥ng popup ngay v√† render UI (∆∞u ti√™n mapUrl)
    async function loginUser({ name, phone, location, deviceId }) {
      const res = await fetch(WEB_APP_MAIN, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ action:'login_user', name, phone, location, deviceId })
      });
      const text = await res.text();
      try {
        const json = JSON.parse(text);
        if (json && json.ok && json.sessionId) return { ok:true, sessionId: json.sessionId, customer: json.customer || null };
      } catch {}
      if (/^ƒêƒÉng nh·∫≠p th√†nh c√¥ng/i.test(text)) {
        const m = text.match(/SESSION:([A-Za-z0-9\-]+)/);
        return { ok:true, sessionId:(m ? m[1] : null), customer:null };
      }
      return { ok:false, message: text || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i' };
    }

    // Submit
    customerForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const name = cusName.value.trim();
      const phone = cusPhone.value.trim().replace(/\s+/g,'');
      const loc = cusLocation.value.trim();
      if(!name){ cusName.focus(); return; }
      if(!/^0[0-9]{9,10}$/.test(phone)){ cusPhone.focus(); return; }
      if(!loc){ cusLocation.focus(); return; }
      if(!consentCustomer.checked){ consentCustomerErr.style.display='block'; consentCustomer.focus(); return; }
      consentCustomerErr.style.display='none';

      const deviceId = ensureDeviceId();

      try{
        customerLoginBtn.disabled = true;
        customerLoginBtn.textContent = '‚è≥ ƒêang ƒëƒÉng nh·∫≠p...';

        const result = await loginUser({ name, phone, location: loc, deviceId });
        if (!result.ok) {
          const msg = result.message || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i';
          if (/kho√° ƒëƒÉng nh·∫≠p trong 24 gi·ªù/i.test(msg)) alert('S·ªë ƒëi·ªán tho·∫°i n√†y ƒëang t·∫°m b·ªã kho√° ƒëƒÉng nh·∫≠p trong 24 gi·ªù.');
          else alert(msg);
          return;
        }

        const customer = result.customer || { name, phone, location: loc, mapUrl: '', updatedAt: '' };
        localStorage.setItem('odcg_customer', JSON.stringify({
          name: customer.name, phone: customer.phone, location: customer.location,
          mapUrl: customer.mapUrl || '', updatedAt: customer.updatedAt || '',
          sessionId: result.sessionId, deviceId, t: Date.now()
        }));

        // ƒê√≥ng popup v√† render h·ªì s∆° ngay
        closeOverlay();
        renderBasicCustomerInfo({ name: customer.name, phone: customer.phone, location: customer.location, mapUrl: customer.mapUrl });

        // L·∫•y l·∫°i info t·ª´ web app info (kh√¥ng ch·∫∑n UI)
        try {
          const infoRes = await fetchCustomerInfoByPhone(phone);
          if (infoRes && infoRes.ok && infoRes.customer) {
            renderBasicCustomerInfo({
              name: infoRes.customer.name || customer.name,
              phone: infoRes.customer.phone || customer.phone,
              location: infoRes.customer.location || customer.location,
              mapUrl: infoRes.customer.mapUrl || customer.mapUrl
            });
          }
        } catch {}

        // B·∫Øt ƒë·∫ßu ping loop (ƒë·ªãnh nghƒ©a ·ªü ph·∫ßn 3)
        if (typeof schedulePingLoop === 'function') schedulePingLoop();

      } catch(err){
        alert('Kh√¥ng th·ªÉ ƒëƒÉng nh·∫≠p: ' + err.message);
      } finally {
        customerLoginBtn.disabled = false;
        customerLoginBtn.textContent = 'ƒêƒÉng nh·∫≠p';
      }
    });

    // Logout
    async function apiLogout(){
      const session = JSON.parse(localStorage.getItem('odcg_customer') || '{}');
      if(!session.phone || !session.deviceId || !session.sessionId){
        localStorage.removeItem('odcg_customer'); removeBasicCustomerInfo(); return;
      }
      try{
        const res = await fetch(WEB_APP_MAIN, {
          method:'POST',
          headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            action:'logout_user',
            phone: session.phone,
            deviceId: session.deviceId,
            sessionId: session.sessionId
          })
        });
        const text = await res.text();
        if (text) alert(text);
      }catch(e){
        alert('L·ªói ƒëƒÉng xu·∫•t: ' + e.message);
      }finally{
        localStorage.removeItem('odcg_customer');
        removeBasicCustomerInfo();
      }
    }

    // Ping session minimal on load (schedule loop in part 3)
    async function pingSession({ phone, deviceId, sessionId }) {
      return postFormJSON(WEB_APP_MAIN, { action:'ping_session', phone, deviceId, sessionId });
    }
    async function restoreSessionIfAnyMinimal() {
      const session = JSON.parse(localStorage.getItem('odcg_customer') || '{}');
      if (!session.phone || !session.sessionId || !session.deviceId) { setAuthButtonsVisibility(false); return; }
      try {
        const pr = await pingSession({ phone: session.phone, deviceId: session.deviceId, sessionId: session.sessionId });
        if (pr.status === 'ACTIVE') {
          renderBasicCustomerInfo({
            name: pr.customer?.name || session.name,
            phone: pr.customer?.phone || session.phone,
            location: pr.customer?.location || session.location,
            mapUrl: pr.customer?.mapUrl || session.mapUrl
          });
          showSessionBannerUI('');
          if (typeof schedulePingLoop === 'function') schedulePingLoop();
        } else if (pr.status === 'OTHER_DEVICE') {
          showSessionBannerUI('S·ªë ƒëi·ªán tho·∫°i n√†y ƒëang ƒëƒÉng nh·∫≠p ·ªü n∆°i kh√°c. Phi√™n hi·ªán t·∫°i ƒë√£ b·ªã ƒëƒÉng xu·∫•t.');
          localStorage.removeItem('odcg_customer');
          removeBasicCustomerInfo();
        } else if (pr.status === 'LOCKED') {
          showSessionBannerUI('S·ªë ƒëi·ªán tho·∫°i n√†y ƒëang t·∫°m b·ªã kho√° ƒëƒÉng nh·∫≠p trong 24 gi·ªù.');
          localStorage.removeItem('odcg_customer');
          removeBasicCustomerInfo();
        } else {
          localStorage.removeItem('odcg_customer');
          removeBasicCustomerInfo();
        }
      } catch {
        setAuthButtonsVisibility(false);
      }
    }
    window.addEventListener('load', restoreSessionIfAnyMinimal);

    // Bottom nav padding
    function updateBottomPadding(){
      if(!bottomNav) return;
      const h = Math.round(bottomNav.getBoundingClientRect().height || 64);
      const current = getComputedStyle(document.documentElement).getPropertyValue('--bottom-nav-pad').trim();
      const next = h + 'px';
      if(current !== next){ document.documentElement.style.setProperty('--bottom-nav-pad', next); }
    }
    window.addEventListener('load', updateBottomPadding);
    window.addEventListener('resize', updateBottomPadding);
    if('ResizeObserver' in window && bottomNav){
      const ro = new ResizeObserver(()=>requestAnimationFrame(updateBottomPadding));
      ro.observe(bottomNav);
    }
  </script>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>

  <script>
    // ====== Geolocation & address helpers ======
    let lastCoords = null;
    let gettingLoc = false;

    function composeMapHrefFromLocationString(locStr){
      return locStr ? `https://maps.google.com/?q=${encodeURIComponent(locStr)}` : '#';
    }

    function updateProfileMapLink({ href, show }) {
      const basicMap = document.getElementById('basicMap');
      if (!basicMap) return;
      if (show && href) {
        basicMap.href = href;
        basicMap.style.display = '';
      } else {
        basicMap.href = '#';
        basicMap.style.display = 'none';
      }
    }

    function updateInlineMapLinks(coords){
      // Update link in login form
      const link = document.getElementById('viewMapLink');
      if (link && coords) {
        const href = `https://maps.google.com/?q=${coords.latitude},${coords.longitude}`;
        link.href = href;
        link.setAttribute('aria-disabled','false');
      }
      // Update link in profile block
      if (coords) {
        const href = `https://maps.google.com/?q=${coords.latitude},${coords.longitude}`;
        updateProfileMapLink({ href, show: true });
      }
    }

    function setGetLocationButtonState(hasCoords){
      if(!getLocationBtn) return;
      getLocationBtn.textContent = hasCoords ? 'üìç C·∫≠p nh·∫≠t l·∫°i ƒë·ªãa ch·ªâ' : 'üìç L·∫•y ƒë·ªãa ch·ªâ hi·ªán t·∫°i';
      getLocationBtn.disabled = false;
    }

    async function reverseGeocode(lat, lon){
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&zoom=16&addressdetails=1`;
      const res = await fetch(url, {
        headers: {
          'Accept': 'application/json',
          'User-Agent': 'O-Day-Co-Gi/1.0 (contact: support@example.com)'
        }
      });
      if(!res.ok) throw new Error('reverse geocode failed');
      const data = await res.json();
      return data.display_name || '';
    }

    async function handleGetLocation(){
      if(gettingLoc) return;
      if(!('geolocation' in navigator)){
        alert('Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã. Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ ho·∫∑c ch·ªçn tr√™n b·∫£n ƒë·ªì.');
        return;
      }
      try{
        gettingLoc = true;
        getLocationBtn.disabled = true;
        getLocationBtn.textContent = '‚è≥ ƒêang l·∫•y v·ªã tr√≠...';
        locHelp.textContent = 'ƒêang l·∫•y v·ªã tr√≠, vui l√≤ng ch·ªù...';

        const coords = await new Promise((resolve, reject)=>{
          navigator.geolocation.getCurrentPosition(
            pos => resolve(pos.coords),
            err => reject(err),
            { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
          );
        });

        lastCoords = { latitude: coords.latitude, longitude: coords.longitude };
        updateInlineMapLinks(lastCoords);

        try{
          const address = await reverseGeocode(lastCoords.latitude, lastCoords.longitude);
          if(address) {
            cusLocation.value = address;
            locHelp.textContent = 'ƒê√£ t·ª± ƒë·ªông ƒëi·ªÅn ƒë·ªãa ch·ªâ c·ªßa b·∫°n. Ki·ªÉm tra l·∫°i cho ch√≠nh x√°c.';
            const locSpan = document.getElementById('basicLoc');
            if (locSpan) locSpan.textContent = address;
          } else {
            locHelp.textContent = 'Kh√¥ng l·∫•y ƒë∆∞·ª£c ƒë·ªãa ch·ªâ ch·ªØ. B·∫°n c√≥ th·ªÉ xem v·ªã tr√≠ tr√™n b·∫£n ƒë·ªì.';
          }
        }catch{
          locHelp.textContent = 'Kh√¥ng th·ªÉ chuy·ªÉn to·∫° ƒë·ªô th√†nh ƒë·ªãa ch·ªâ. D√πng li√™n k·∫øt ƒë·ªÉ xem tr√™n b·∫£n ƒë·ªì.';
        }

        setGetLocationButtonState(true);

        // G·ª≠i c·∫≠p nh·∫≠t v·ªã tr√≠ (im l·∫∑ng) l√™n web app ch√≠nh
        try {
          const session = JSON.parse(localStorage.getItem('odcg_customer') || '{}');
          if (session.phone && session.deviceId) {
            await fetch(WEB_APP_MAIN, {
              method:'POST',
              headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
              body: new URLSearchParams({
                action: 'update_location',
                phone: session.phone,
                location: cusLocation.value.trim(),
                deviceId: session.deviceId
              })
            });
          }
        } catch {}

      }catch(err){
        console.warn('Geolocation error:', err);
        alert('Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠. Ki·ªÉm tra quy·ªÅn truy c·∫≠p v·ªã tr√≠ ho·∫∑c d√πng ‚ÄúCh·ªçn tr√™n b·∫£n ƒë·ªì‚Äù.');
        setGetLocationButtonState(!!lastCoords);
        const link = document.getElementById('viewMapLink');
        if(link && !lastCoords){
          link.setAttribute('aria-disabled','true');
          link.href = '#';
        }
        locHelp.textContent = 'B·∫°n c√≥ th·ªÉ nh·∫≠p ƒë·ªãa ch·ªâ ho·∫∑c ch·ªçn tr√™n b·∫£n ƒë·ªì n·∫øu kh√¥ng c·∫•p quy·ªÅn v·ªã tr√≠.';
      }finally{
        gettingLoc = false;
        if(!getLocationBtn) return;
        getLocationBtn.disabled = false;
        if(!lastCoords) getLocationBtn.textContent = 'üìç L·∫•y ƒë·ªãa ch·ªâ hi·ªán t·∫°i';
      }
    }
    getLocationBtn.addEventListener('click', handleGetLocation);

    // Khi ng∆∞·ªùi d√πng s·ª≠a tay ƒë·ªãa ch·ªâ, n·∫øu ch∆∞a c√≥ to·∫° ƒë·ªô th√¨ v√¥ hi·ªáu map link trong form
    cusLocation.addEventListener('input', ()=>{
      if(!lastCoords){
        const link = document.getElementById('viewMapLink');
        if(link){
          link.setAttribute('aria-disabled','true');
          link.href = '#';
        }
      }
    });

    // ====== AUTOCOMPLETE (Nominatim) ======
    let suggestTimer = null;
    locSearch.addEventListener('input', ()=>{
      const q = locSearch.value.trim();
      clearTimeout(suggestTimer);
      if(q.length < 3){
        locSuggest.style.display = 'none';
        locList.innerHTML = '';
        return;
      }
      suggestTimer = setTimeout(()=> fetchSuggest(q), 300);
    });

    async function fetchSuggest(query){
      try{
        const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&limit=8&countrycodes=vn&q=${encodeURIComponent(query)}`;
        const res = await fetch(url, {
          headers: {
            'Accept': 'application/json',
            'User-Agent': 'O-Day-Co-Gi/1.0 (contact: support@example.com)'
          }
        });
        if(!res.ok) throw new Error('suggest failed');
        const data = await res.json();
        renderSuggest(data);
      }catch{
        locSuggest.style.display = 'none';
        locList.innerHTML = '';
      }
    }

    function renderSuggest(items){
      locList.innerHTML = '';
      if(!items || !items.length){
        locSuggest.style.display = 'none';
        return;
      }
      items.forEach(item=>{
        const li = document.createElement('li');
        li.style.margin = '0';
        li.style.padding = '8px 10px';
        li.style.cursor = 'pointer';
        li.style.borderRadius = '8px';
        li.textContent = item.display_name;
        li.addEventListener('click', async ()=>{
          cusLocation.value = item.display_name || '';
          lastCoords = { latitude: parseFloat(item.lat), longitude: parseFloat(item.lon) };
          updateInlineMapLinks(lastCoords);
          setGetLocationButtonState(true);
          locSuggest.style.display = 'none';
          locList.innerHTML = '';
          locHelp.textContent = 'ƒê√£ ch·ªçn ƒë·ªãa ch·ªâ t·ª´ g·ª£i √Ω. B·∫°n c√≥ th·ªÉ b·∫•m ‚Äúv·ªã tr√≠ c·ªßa b·∫°n‚Äù ƒë·ªÉ ki·ªÉm tra.';

          // ƒê·ªìng b·ªô hi·ªÉn th·ªã h·ªì s∆°
          const locSpan = document.getElementById('basicLoc');
          if (locSpan) locSpan.textContent = cusLocation.value.trim();

          // G·ª≠i c·∫≠p nh·∫≠t v·ªã tr√≠ im l·∫∑ng
          try {
            const session = JSON.parse(localStorage.getItem('odcg_customer') || '{}');
            if (session.phone && session.deviceId) {
              await fetch(WEB_APP_MAIN, {
                method:'POST',
                headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
                body: new URLSearchParams({
                  action: 'update_location',
                  phone: session.phone,
                  location: cusLocation.value.trim(),
                  deviceId: session.deviceId
                })
              });
            }
          } catch {}
        });
        li.addEventListener('mouseenter', ()=> li.style.background = '#FFF7F8');
        li.addEventListener('mouseleave', ()=> li.style.background = 'transparent');
        locList.appendChild(li);
      });
      locSuggest.style.display = 'block';
    }

    // ·∫®n g·ª£i √Ω khi click ra ngo√†i
    document.addEventListener('click', (e)=>{
      if(!locSuggest.contains(e.target) && e.target !== locSearch){
        locSuggest.style.display = 'none';
      }
    });

    // ====== MAP (Leaflet) ch·ªçn v·ªã tr√≠ ======
    let map, marker;
let mapTargetInput = null;

    const defaultCenter = { lat: 10.775, lng: 106.7 }; // HCMC

    function initMapIfNeeded(){
      if(map){
        map.invalidateSize();
        return;
      }
      map = L.map('pickMap').setView([defaultCenter.lat, defaultCenter.lng], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      marker = L.marker(map.getCenter(), { draggable: true }).addTo(map);

      marker.on('dragend', ()=>{
        const { lat, lng } = marker.getLatLng();
        document.getElementById('mapHelp').textContent = `To·∫° ƒë·ªô t·∫°m: ${lat.toFixed(6)}, ${lng.toFixed(6)} ‚Äî b·∫•m X√°c nh·∫≠n ƒë·ªÉ d√πng.`;
      });

      if(lastCoords){
        marker.setLatLng([lastCoords.latitude, lastCoords.longitude]);
        map.setView([lastCoords.latitude, lastCoords.longitude], 15);
      }
    }

    // M·ªü dialog b·∫£n ƒë·ªì
    pickOnMapBtn.addEventListener('click', ()=>{
  mapTargetInput = document.getElementById('cusLocation'); // th√™m d√≤ng n√†y
  showMapDialog();
  initMapIfNeeded();
  setTimeout(()=> map && map.invalidateSize(), 50);
});



    // N√∫t ƒë∆∞a ghim v·ªÅ v·ªã tr√≠ c·ªßa t√¥i
    document.getElementById('mapMyLoc').addEventListener('click', async ()=>{
      if(!('geolocation' in navigator)){
        alert('Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.');
        return;
      }
      try{
        document.getElementById('mapHelp').textContent = 'ƒêang l·∫•y v·ªã tr√≠ c·ªßa b·∫°n...';
        const coords = await new Promise((resolve, reject)=>{
          navigator.geolocation.getCurrentPosition(
            pos => resolve(pos.coords),
            err => reject(err),
            { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
          );
        });
        const latlng = [coords.latitude, coords.longitude];
        marker.setLatLng(latlng);
        map.setView(latlng, 16);
        document.getElementById('mapHelp').textContent = 'ƒê√£ ƒë∆∞a ghim v·ªÅ v·ªã tr√≠ c·ªßa b·∫°n. K√©o tinh ch·ªânh n·∫øu c·∫ßn.';
      }catch{
        document.getElementById('mapHelp').textContent = 'Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠. B·∫°n c√≥ th·ªÉ k√©o ghim ƒë·∫øn v·ªã tr√≠ mong mu·ªën.';
      }
    });

    // X√°c nh·∫≠n v·ªã tr√≠ tr√™n b·∫£n ƒë·ªì
    document.getElementById('mapConfirm').addEventListener('click', async () => {
  const { lat, lng } = marker.getLatLng();
lastCoords = { latitude: lat, longitude: lng };
updateInlineMapLinks(lastCoords);

// üëá TH√äM D√íNG N√ÄY
if (mapTargetInput && mapTargetInput.id === 'currentAddress') {
  updateRegisterMapReviewLink(lat, lng);
}


  let addressText = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
  const target = mapTargetInput || document.getElementById('cusLocation');

  try {
    const address = await reverseGeocode(lat, lng);
    if (address) addressText = address;

    if (target) target.value = addressText;

    const locSpan = document.getElementById('basicLoc');
    if (locSpan && target) locSpan.textContent = target.value.trim();

    locHelp.textContent = 'ƒê√£ c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ t·ª´ v·ªã tr√≠ b·∫£n ƒë·ªì.';
  } catch {
    if (target) target.value = addressText;

    const locSpan = document.getElementById('basicLoc');
    if (locSpan && target) locSpan.textContent = target.value.trim();

    locHelp.textContent = 'Kh√¥ng th·ªÉ chuy·ªÉn to·∫° ƒë·ªô th√†nh ƒë·ªãa ch·ªâ. ƒê√£ ƒëi·ªÅn to·∫° ƒë·ªô thay th·∫ø.';
  }

  setGetLocationButtonState(true);

  try {
    const session = JSON.parse(localStorage.getItem('odcg_customer') || '{}');
    if (session.phone && session.deviceId) {
      await fetch(WEB_APP_MAIN, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          action: 'update_location',
          phone: session.phone,
          location: (target?.value || '').trim(),
          deviceId: session.deviceId
        })
      });
    }
  } catch {}

  // ƒê√≥ng popup b·∫£n ƒë·ªì v√† quay l·∫°i ƒë√∫ng form ngu·ªìn
  document.getElementById('mapBox').hidden = true;

  if (mapTargetInput && mapTargetInput.id === 'currentAddress') {
    document.getElementById('registerDialog').hidden = false;
  } else {
    document.getElementById('customerBox').hidden = false;
  }

  setTimeout(() => target && target.focus(), 0);
});

    // ====== Prefill theo IP (tu·ª≥ ch·ªçn) ======
    async function prefillByIP(){
      try{
        const r = await fetch('https://ipapi.co/json/');
        if(!r.ok) return;
        const d = await r.json();
        const approx = [d.city, d.region, d.country_name].filter(Boolean).join(', ');
        if(approx && !cusLocation.value){
          cusLocation.value = approx;
          locHelp.textContent = 'ƒê√£ ƒëi·ªÅn s∆° b·ªô theo IP. Vui l√≤ng ki·ªÉm tra v√† ch·ªânh l·∫°i n·∫øu c·∫ßn.';
        }
      }catch{}
    }
    roleCustomerBtn.addEventListener('click', prefillByIP);

    // ====== Ping loop m·ªói 5 ph√∫t ======
    let pingTimer = null;
    function schedulePingLoop() {
      if (pingTimer) clearInterval(pingTimer);
      pingTimer = setInterval(async ()=>{
        const session = JSON.parse(localStorage.getItem('odcg_customer') || '{}');
        if (!session.phone || !session.sessionId || !session.deviceId) {
          clearInterval(pingTimer);
          return;
        }
        try {
          const pr = await (async function pingSessionWrap() {
            const res = await fetch(WEB_APP_MAIN, {
              method:'POST',
              headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
              body: new URLSearchParams({
                action:'ping_session',
                phone: session.phone,
                deviceId: session.deviceId,
                sessionId: session.sessionId
              })
            });
            const text = await res.text();
            try { return JSON.parse(text); } catch { return { ok:false, status:'INVALID', message:text }; }
          })();

          if (pr.status !== 'ACTIVE') {
            clearInterval(pingTimer);
            if (pr.status === 'OTHER_DEVICE') {
              showSessionBannerUI && showSessionBannerUI('Phi√™n c·ªßa b·∫°n ƒë√£ b·ªã thu h·ªìi v√¨ ƒëƒÉng nh·∫≠p t·ª´ n∆°i kh√°c.');
            } else if (pr.status === 'EXPIRED') {
              showSessionBannerUI && showSessionBannerUI('Phi√™n ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
            } else if (pr.status === 'LOCKED') {
              showSessionBannerUI && showSessionBannerUI('S·ªë ƒëi·ªán tho·∫°i n√†y ƒëang t·∫°m b·ªã kho√° ƒëƒÉng nh·∫≠p trong 24 gi·ªù.');
            }
            localStorage.removeItem('odcg_customer');
            if (typeof removeBasicCustomerInfo === 'function') removeBasicCustomerInfo();
          } else {
            // C·∫≠p nh·∫≠t nhanh UI n·∫øu customer thay ƒë·ªïi (∆∞u ti√™n mapUrl)
            const nameEl = document.getElementById('basicName');
            const phoneEl = document.getElementById('basicPhone');
            const locEl = document.getElementById('basicLoc');
            if (pr.customer) {
              if (nameEl) nameEl.textContent = pr.customer.name || nameEl.textContent;
              if (phoneEl) phoneEl.textContent = pr.customer.phone || phoneEl.textContent;

              // location (text) c√≥ th·ªÉ tr·ªëng, v√¨ ta ∆∞u ti√™n mapUrl
              if (locEl) locEl.textContent = pr.customer.location || locEl.textContent;

              // c·∫≠p nh·∫≠t link "v·ªã tr√≠ c·ªßa b·∫°n"
              if (pr.customer.mapUrl) {
                updateProfileMapLink({ href: pr.customer.mapUrl, show: true });
              } else if (pr.customer.location) {
                updateProfileMapLink({ href: composeMapHrefFromLocationString(pr.customer.location), show: true });
              }
            }
            showSessionBannerUI && showSessionBannerUI('');
          }
        } catch (e) {
          console.warn('ping loop error', e);
        }
      }, 5 * 60 * 1000); // 5 ph√∫t
    }
// ===== T·ª∞ ƒê·ªòNG G·∫ÆN protected-card CHO T·∫§T C·∫¢ .card =====
document.addEventListener('DOMContentLoaded', function () {
  document.querySelectorAll('.card').forEach(card => {
    if (!card.classList.contains('protected-card')) {
      card.classList.add('protected-card');
    }
  });
});

// ===== H√ÄM KI·ªÇM TRA ƒêƒÇNG NH·∫¨P =====
function isLoggedIn() {
  const session = JSON.parse(localStorage.getItem('odcg_customer') || '{}');
  return !!(session && session.sessionId);
}

// ===== CH·∫∂N CLICK N·∫æU CH∆ØA ƒêƒÇNG NH·∫¨P =====
document.addEventListener('click', function (e) {
  const card = e.target.closest('.protected-card');
  if (card && !isLoggedIn()) {
    e.preventDefault();
    e.stopPropagation();
    // M·ªü form ƒëƒÉng nh·∫≠p kh√°ch h√†ng
    showCustomerDialog();
    // Rung form
    const customerBox = document.getElementById('customerBox');
    customerBox.classList.add('shake');
    setTimeout(() => customerBox.classList.remove('shake'), 500);
    // Focus √¥ SƒêT
    setTimeout(() => {
      const phoneInput = document.getElementById('cusPhone');
      if (phoneInput) phoneInput.focus();
    }, 100);
  }
});
  // B·∫ÆT ƒê·∫¶U CH√àN
  // ===== Popup th√¥ng b√°o ƒëƒÉng nh·∫≠p =====
  const loginNoticeOverlay = document.getElementById('loginNoticeOverlay');
  const closeLoginNotice = document.getElementById('closeLoginNotice');
  const loginNoticeBtn = document.getElementById('loginNoticeBtn');

  function showLoginNotice() {
    loginNoticeOverlay.style.display = 'flex';
  }
  function closeLoginNoticePopup() {
    loginNoticeOverlay.style.display = 'none';
  }

  closeLoginNotice.addEventListener('click', closeLoginNoticePopup);
  loginNoticeBtn.addEventListener('click', () => {
    closeLoginNoticePopup();
    loginBtn.click(); // G·ªçi h√†nh vi n√∫t ƒëƒÉng nh·∫≠p ·ªü header
  });

  // ===== Ki·ªÉm tra ƒëƒÉng nh·∫≠p =====
  function isLoggedIn() {
    const session = JSON.parse(localStorage.getItem('odcg_customer') || '{}');
    return !!(session && session.sessionId);
  }

  // ===== Ch·∫∑n click card n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p =====
  document.addEventListener('click', function (e) {
    const card = e.target.closest('.card');
    if (card && !isLoggedIn()) {
      e.preventDefault();
      e.stopPropagation();
      showLoginNotice();
    }
  });
// B·∫ÆT ƒê·∫¶U CH√àN - Toggle m·∫≠t kh·∫©u chuy√™n gia
document.querySelector('.toggle-password').addEventListener('click', function () {
  const input = document.getElementById('expertPassword');
  const icon = this.querySelector('i');
  if (input.type === 'password') {
    input.type = 'text';
    icon.classList.remove('fa-eye');
    icon.classList.add('fa-eye-slash');
  } else {
    input.type = 'password';
    icon.classList.remove('fa-eye-slash');
    icon.classList.add('fa-eye');
  }
});
// K·∫æT TH√öC CH√àN

 
  </script>
 

