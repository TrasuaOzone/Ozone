<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ÄÄ‚NG KÃ LÃ€M Dá»ŠCH Vá»¤ GPS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    body {font-family: sans-serif; background: #f0f0f0; padding: 40px; max-width: 520px; margin: auto;}
    label {display: block; margin-top: 16px; font-weight: 600;}
    input, textarea, select {width: 100%; padding: 8px; margin-top: 6px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; box-sizing: border-box;}
    .row {display: flex; gap: 10px;}
    .row > * {flex: 1;}
    .btn {margin-top: 18px; padding: 10px 16px; font-size: 16px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer;}
    .btn.secondary {background: #555;}
    .status {margin-top: 12px; font-size: 13px; color: #555;}
    .status.ok {color: #0a7a0a;}
    .status.warn {color: #b35a00;}
    .status.err {color: #b00020;}
    .muted {color:#777; font-size: 12px; margin-top: 6px;}
  </style>
</head>
<body>
  <h2>ğŸ“‹ ÄÄ‚NG KÃ LÃ€M Dá»ŠCH Vá»¤</h2>

  <form id="testForm">
    <label>ğŸ‘¤ Há» tÃªn:</label>
    <input type="text" name="name" required>

    <label>ğŸ“± Sá»‘ Ä‘iá»‡n thoáº¡i (10 sá»‘):</label>
    <input type="tel" name="phone" pattern="[0-9]{10}" maxlength="10" required title="Nháº­p Ä‘Ãºng 10 chá»¯ sá»‘">

    <label>ğŸ†” CÄƒn cÆ°á»›c cÃ´ng dÃ¢n (12 sá»‘):</label>
    <input type="text" name="idcard" pattern="[0-9]{12}" maxlength="12" required title="Nháº­p Ä‘Ãºng 12 chá»¯ sá»‘">

    <label>ğŸ› ï¸ NgÃ nh nghá»:</label>
    <select name="job" required>
      <option value="">-- Chá»n ngÃ nh nghá» --</option>
      <option value="TÃ i xáº¿">TÃ i xáº¿</option>
      <option value="Giao hÃ ng">Giao hÃ ng</option>
      <option value="Káº¿ toÃ¡n">Káº¿ toÃ¡n</option>
      <option value="Báº£o vá»‡">Báº£o vá»‡</option>
      <option value="KhÃ¡c">KhÃ¡c</option>
    </select>

    <label>ğŸ“ Khu vá»±c:</label>
    <select name="area" required>
  <option value="">-- Chá»n khu vá»±c --</option>
  <option value="HÃ  Ná»™i">HÃ  Ná»™i</option>
  <option value="VÄ©nh PhÃºc">VÄ©nh PhÃºc</option>
  <option value="Báº¯c Ninh">Báº¯c Ninh</option>
  <option value="Quáº£ng Ninh">Quáº£ng Ninh</option>
  <option value="Háº£i DÆ°Æ¡ng">Háº£i DÆ°Æ¡ng</option>
  <option value="Háº£i PhÃ²ng">Háº£i PhÃ²ng</option>
  <option value="HÆ°ng YÃªn">HÆ°ng YÃªn</option>
  <option value="ThÃ¡i BÃ¬nh">ThÃ¡i BÃ¬nh</option>
  <option value="HÃ  Nam">HÃ  Nam</option>
  <option value="Nam Äá»‹nh">Nam Äá»‹nh</option>
  <option value="Ninh BÃ¬nh">Ninh BÃ¬nh</option>
  <option value="HÃ  Giang">HÃ  Giang</option>
  <option value="Cao Báº±ng">Cao Báº±ng</option>
  <option value="Báº¯c Káº¡n">Báº¯c Káº¡n</option>
  <option value="TuyÃªn Quang">TuyÃªn Quang</option>
  <option value="LÃ o Cai">LÃ o Cai</option>
  <option value="YÃªn BÃ¡i">YÃªn BÃ¡i</option>
  <option value="ThÃ¡i NguyÃªn">ThÃ¡i NguyÃªn</option>
  <option value="Láº¡ng SÆ¡n">Láº¡ng SÆ¡n</option>
  <option value="Báº¯c Giang">Báº¯c Giang</option>
  <option value="PhÃº Thá»">PhÃº Thá»</option>
  <option value="Äiá»‡n BiÃªn">Äiá»‡n BiÃªn</option>
  <option value="Lai ChÃ¢u">Lai ChÃ¢u</option>
  <option value="SÆ¡n La">SÆ¡n La</option>
  <option value="HoÃ  BÃ¬nh">HoÃ  BÃ¬nh</option>
  <option value="Thanh HoÃ¡">Thanh HoÃ¡</option>
  <option value="Nghá»‡ An">Nghá»‡ An</option>
  <option value="HÃ  TÄ©nh">HÃ  TÄ©nh</option>
  <option value="Quáº£ng BÃ¬nh">Quáº£ng BÃ¬nh</option>
  <option value="Quáº£ng Trá»‹">Quáº£ng Trá»‹</option>
  <option value="Thá»«a ThiÃªn Huáº¿">Thá»«a ThiÃªn Huáº¿</option>
  <option value="ÄÃ  Náºµng">ÄÃ  Náºµng</option>
  <option value="Quáº£ng Nam">Quáº£ng Nam</option>
  <option value="Quáº£ng NgÃ£i">Quáº£ng NgÃ£i</option>
  <option value="BÃ¬nh Äá»‹nh">BÃ¬nh Äá»‹nh</option>
  <option value="PhÃº YÃªn">PhÃº YÃªn</option>
  <option value="KhÃ¡nh HoÃ ">KhÃ¡nh HoÃ </option>
  <option value="Ninh Thuáº­n">Ninh Thuáº­n</option>
  <option value="BÃ¬nh Thuáº­n">BÃ¬nh Thuáº­n</option>
  <option value="TÃ¢y NguyÃªn">TÃ¢y NguyÃªn</option>
  <option value="Kon Tum">Kon Tum</option>
  <option value="Gia Lai">Gia Lai</option>
  <option value="Äáº¯k Láº¯k">Äáº¯k Láº¯k</option>
  <option value="Äáº¯k NÃ´ng">Äáº¯k NÃ´ng</option>
  <option value="LÃ¢m Äá»“ng">LÃ¢m Äá»“ng</option>
  <option value="ÄÃ´ng Nam Bá»™">ÄÃ´ng Nam Bá»™</option>
  <option value="BÃ¬nh PhÆ°á»›c">BÃ¬nh PhÆ°á»›c</option>
  <option value="TÃ¢y Ninh">TÃ¢y Ninh</option>
  <option value="BÃ¬nh DÆ°Æ¡ng">BÃ¬nh DÆ°Æ¡ng</option>
  <option value="Äá»“ng Nai">Äá»“ng Nai</option>
  <option value="BÃ  Rá»‹a - VÅ©ng TÃ u">BÃ  Rá»‹a - VÅ©ng TÃ u</option>
  <option value="TP.Há»“ ChÃ­ Minh">TP.Há»“ ChÃ­ Minh</option>
  <option value="Long An">Long An</option>
  <option value="Tiá»n Giang">Tiá»n Giang</option>
  <option value="Báº¿n Tre">Báº¿n Tre</option>
  <option value="TrÃ  Vinh">TrÃ  Vinh</option>
  <option value="VÄ©nh Long">VÄ©nh Long</option>
  <option value="Äá»“ng ThÃ¡p">Äá»“ng ThÃ¡p</option>
  <option value="An Giang">An Giang</option>
  <option value="KiÃªn Giang">KiÃªn Giang</option>
  <option value="Cáº§n ThÆ¡">Cáº§n ThÆ¡</option>
  <option value="Háº­u Giang">Háº­u Giang</option>
  <option value="SÃ³c TrÄƒng">SÃ³c TrÄƒng</option>
  <option value="Báº¡c LiÃªu">Báº¡c LiÃªu</option>
  <option value="CÃ  Mau">CÃ  Mau</option>
    </select>

    <label>ğŸ•’ Thá»i gian lÃ m:</label>
    <select name="time" required>
      <option value="">-- Chá»n thá»i gian --</option>
      <option value="SÃ¡ng">SÃ¡ng</option>
      <option value="Chiá»u">Chiá»u</option>
      <option value="Tá»‘i">Tá»‘i</option>
      <option value="Cáº£ ngÃ y">Cáº£ ngÃ y</option>
    </select>

    <!-- ThÃªm pháº§n máº­t kháº©u -->
    <label>ğŸ”‘ Máº­t kháº©u:</label>
    <input type="password" name="password" id="password" required minlength="4" placeholder="Nháº­p máº­t kháº©u">

    <label>ğŸ”‘ Nháº­p láº¡i máº­t kháº©u:</label>
    <input type="password" name="confirm_password" id="confirm_password" required minlength="4" placeholder="Nháº­p láº¡i máº­t kháº©u">

    <label>ğŸ“ Ghi chÃº:</label>
    <textarea name="note" rows="2" placeholder="Ghi chÃº thÃªm náº¿u cÃ³..."></textarea>

    <label>ğŸ  Äá»‹a chá»‰ hiá»‡n táº¡i:</label>
    <div class="row">
      <input type="text" name="address" id="address" placeholder="Nháº­p Ä‘á»‹a chá»‰ hoáº·c báº¥m 'DÃ¹ng vá»‹ trÃ­ hiá»‡n táº¡i'">
      <button type="button" class="btn secondary" id="btnUseCurrent">DÃ¹ng vá»‹ trÃ­ hiá»‡n táº¡i</button>
    </div>
    <div class="muted">CÃ³ thá»ƒ nháº­p tay hoáº·c tá»± Ä‘á»™ng Ä‘iá»n tá»« GPS.</div>

    <input type="hidden" id="latitude">
    <input type="hidden" id="longitude">

    <button type="submit" class="btn" id="btnSubmit">ğŸ“¤ Gá»­i</button>
    <div id="gpsStatus" class="status">Tráº¡ng thÃ¡i GPS: chÆ°a láº¥y vá»‹ trÃ­.</div>
    <div id="submitStatus" class="status"></div>
  </form>
<script>
  const gpsStatus = document.getElementById("gpsStatus");
  const submitStatus = document.getElementById("submitStatus");
  const btnSubmit = document.getElementById("btnSubmit");
  const btnUseCurrent = document.getElementById("btnUseCurrent");
  const latEl = document.getElementById("latitude");
  const lngEl = document.getElementById("longitude");
  const addrEl = document.getElementById("address");

  function setStatus(msg, level) {
    gpsStatus.textContent = "Tráº¡ng thÃ¡i GPS: " + msg;
    gpsStatus.className = "status " + (level || "");
  }

  async function onGeoSuccess(pos, opts = {}) {
    const { latitude, longitude } = pos.coords;
    latEl.value = latitude;
    lngEl.value = longitude;
    setStatus(`Ä‘Ã£ láº¥y (${latitude.toFixed(6)}, ${longitude.toFixed(6)})`, "ok");

    if (opts.fillAddress || !addrEl.value.trim()) {
      try {
        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}&accept-language=vi`;
        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        if (res.ok) {
          const data = await res.json();
          if (data.display_name && !addrEl.value.trim()) {
            addrEl.value = data.display_name;
          }
        }
      } catch {}
    }
  }

  function onGeoError(err) {
    setStatus(`chÆ°a cÃ³ vá»‹ trÃ­ (${err.message})`, "warn");
  }

  // Láº¥y GPS khi load
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(onGeoSuccess, onGeoError, { enableHighAccuracy: true, timeout: 15000 });
  }

  // NÃºt "DÃ¹ng vá»‹ trÃ­ hiá»‡n táº¡i"
  btnUseCurrent.addEventListener("click", () => {
    setStatus("Ä‘ang láº¥y...", "warn");
    navigator.geolocation.getCurrentPosition(
      pos => onGeoSuccess(pos, { fillAddress: true }),
      onGeoError,
      { enableHighAccuracy: true, timeout: 20000 }
    );
  });

  // Submit form
  document.getElementById("testForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    submitStatus.textContent = "";

    // Kiá»ƒm tra máº­t kháº©u
    const pass1 = document.getElementById("password").value.trim();
    const pass2 = document.getElementById("confirm_password").value.trim();
    if (pass1.length < 4) {
      submitStatus.textContent = "âš ï¸ Máº­t kháº©u pháº£i cÃ³ Ã­t nháº¥t 4 kÃ½ tá»±";
      submitStatus.className = "status err";
      return;
    }
    if (pass1 !== pass2) {
      submitStatus.textContent = "âš ï¸ Máº­t kháº©u nháº­p láº¡i khÃ´ng khá»›p";
      submitStatus.className = "status err";
      return;
    }

    // Kiá»ƒm tra GPS
    if (!latEl.value || !lngEl.value) {
      setStatus("chÆ°a cÃ³ vá»‹ trÃ­. Vui lÃ²ng báº­t GPS hoáº·c báº¥m 'DÃ¹ng vá»‹ trÃ­ hiá»‡n táº¡i'", "err");
      return;
    }

    const formData = new FormData(this);
    const gmapsLink = `https://www.google.com/maps?q=${latEl.value},${lngEl.value}`;
    formData.append("gmaps_link", gmapsLink);

    btnSubmit.disabled = true;
    const prevText = btnSubmit.textContent;
    btnSubmit.textContent = "â³ Äang gá»­i...";

    try {
      const res = await fetch("https://script.google.com/macros/s/AKfycbxeA3v7qx8YY2_XsY3-kppB1jZspUWC4s5ClB-xNHlOmUnGjqowpPPernTJHfXK-kqxKw/exec", {
        method: "POST",
        body: formData
      });
      const text = await res.text();

      // Náº¿u trÃ¹ng CCCD + nghá»
      if (text.includes("âš ï¸ CCCD nÃ y Ä‘Ã£ Ä‘Äƒng kÃ½ ngÃ nh nghá» nÃ y rá»“i")) {
        submitStatus.textContent = text;
        submitStatus.className = "status err";
      } else {
        submitStatus.innerHTML = `
          âœ… ${text}<br>
          <a href="${gmapsLink}" target="_blank" style="color:#007bff;text-decoration:underline;">
            ğŸ“ Xem vá»‹ trÃ­ trÃªn Google Maps
          </a>
        `;
        submitStatus.className = "status ok";
        this.reset();
        setStatus("chÆ°a láº¥y vá»‹ trÃ­.", "warn");
      }
    } catch (err) {
      submitStatus.textContent = "âŒ Lá»—i gá»­i: " + err.message;
      submitStatus.className = "status err";
    } finally {
      btnSubmit.disabled = false;
      btnSubmit.textContent = prevText;
    }
  });

  // ÄÄƒng kÃ½ Service Worker Ä‘á»ƒ chá»‘ng cache
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(() => console.log("âœ… Service Worker Ä‘Ã£ Ä‘Äƒng kÃ½ cho dang-ky.html"))
      .catch(err => console.error("âŒ Lá»—i SW:", err));
  }
</script>
</body>
</html>