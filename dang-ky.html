<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>ÄÄ‚NG KÃ LÃ€M Dá»ŠCH Vá»¤ GPS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ğŸ›¡ Chá»‘ng cache HTML -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<style>
  body {font-family: sans-serif; background: #f0f0f0; padding: 40px; max-width: 520px; margin: auto;}
  label {display: block; margin-top: 16px; font-weight: 600;}
  input, textarea, select {width: 100%; padding: 8px; margin-top: 6px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; box-sizing: border-box;}
  .row {display: flex; gap: 10px;}
  .row > * {flex: 1;}
  .btn {margin-top: 18px; padding: 10px 16px; font-size: 16px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer;}
  .btn.secondary {background: #555;}
  .status {margin-top: 12px; font-size: 13px; color: #555;}
  .status.ok {color: #0a7a0a;}
  .status.warn {color: #b35a00;}
  .status.err {color: #b00020;}
  .muted {color:#777; font-size: 12px; margin-top: 6px;}
</style>
</head>
<body>
<h2>ğŸ“‹ ÄÄ‚NG KÃ LÃ€M Dá»ŠCH Vá»¤</h2>

<form id="testForm">
  <label>ğŸ‘¤ Há» tÃªn:</label>
  <input type="text" name="name" required>

  <label>ğŸ“± Sá»‘ Ä‘iá»‡n thoáº¡i (10 sá»‘):</label>
  <input type="tel" name="phone" pattern="[0-9]{10}" maxlength="10" required title="Nháº­p Ä‘Ãºng 10 chá»¯ sá»‘">

  <label>ğŸ†” CÄƒn cÆ°á»›c cÃ´ng dÃ¢n (12 sá»‘):</label>
  <input type="text" name="idcard" pattern="[0-9]{12}" maxlength="12" required title="Nháº­p Ä‘Ãºng 12 chá»¯ sá»‘">

  <label>ğŸ› ï¸ NgÃ nh nghá»:</label>
  <select name="job" required>
    <option value="">-- Chá»n ngÃ nh nghá» --</option>
    <option value="TÃ i xáº¿">TÃ i xáº¿</option>
    <option value="Giao hÃ ng">Giao hÃ ng</option>
    <option value="Káº¿ toÃ¡n">Káº¿ toÃ¡n</option>
    <option value="Báº£o vá»‡">Báº£o vá»‡</option>
    <option value="KhÃ¡c">KhÃ¡c</option>
  </select>

  <label>ğŸ“ Khu vá»±c:</label>
  <select name="area" required>
    <option value="">-- Chá»n khu vá»±c --</option>
    <option value="HCM">HCM</option>
    <option value="BRVT">BÃ  Rá»‹a - VÅ©ng TÃ u</option>
    <option value="ÄN">ÄÃ  Náºµng</option>
    <option value="HN">HÃ  Ná»™i</option>
    <option value="CT">Cáº§n ThÆ¡</option>
  </select>

  <label>ğŸ•’ Thá»i gian lÃ m:</label>
  <select name="time" required>
    <option value="">-- Chá»n thá»i gian --</option>
    <option value="SÃ¡ng">SÃ¡ng</option>
    <option value="Chiá»u">Chiá»u</option>
    <option value="Tá»‘i">Tá»‘i</option>
    <option value="Cáº£ ngÃ y">Cáº£ ngÃ y</option>
  </select>

  <label>ğŸ  Äá»‹a chá»‰ hiá»‡n táº¡i:</label>
  <div class="row">
    <input type="text" name="address" id="address" placeholder="Nháº­p Ä‘á»‹a chá»‰ hoáº·c báº¥m 'DÃ¹ng vá»‹ trÃ­ hiá»‡n táº¡i'">
    <button type="button" class="btn secondary" id="btnUseCurrent">DÃ¹ng vá»‹ trÃ­ hiá»‡n táº¡i</button>
  </div>
  <div class="muted">CÃ³ thá»ƒ nháº­p tay hoáº·c tá»± Ä‘á»™ng Ä‘iá»n tá»« GPS.</div>

  <input type="hidden" name="latitude" id="latitude">
  <input type="hidden" name="longitude" id="longitude">

  <button type="submit" class="btn" id="btnSubmit">ğŸ“¤ Gá»­i</button>
  <div id="gpsStatus" class="status">Tráº¡ng thÃ¡i GPS: chÆ°a láº¥y vá»‹ trÃ­.</div>
  <div id="submitStatus" class="status"></div>
</form>

<script>
  const gpsStatus = document.getElementById("gpsStatus");
  const submitStatus = document.getElementById("submitStatus");
  const btnSubmit = document.getElementById("btnSubmit");
  const btnUseCurrent = document.getElementById("btnUseCurrent");
  const latEl = document.getElementById("latitude");
  const lngEl = document.getElementById("longitude");
  const addrEl = document.getElementById("address");

  function setStatus(msg, level) {
    gpsStatus.textContent = "Tráº¡ng thÃ¡i GPS: " + msg;
    gpsStatus.className = "status " + (level || "");
  }

  async function onGeoSuccess(pos, opts = {}) {
    const { latitude, longitude } = pos.coords;
    latEl.value = latitude;
    lngEl.value = longitude;
    setStatus(`Ä‘Ã£ láº¥y (${latitude.toFixed(6)}, ${longitude.toFixed(6)})`, "ok");
    if (opts.fillAddress || !addrEl.value.trim()) {
      try {
        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}&accept-language=vi`;
        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        if (res.ok) {
          const data = await res.json();
          if (data.display_name && !addrEl.value.trim()) {
            addrEl.value = data.display_name;
          }
        }
      } catch {}
    }
  }

  function onGeoError(err) {
    setStatus(`chÆ°a cÃ³ vá»‹ trÃ­ (${err.message})`, "warn");
  }

  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(onGeoSuccess, onGeoError, { enableHighAccuracy: true, timeout: 15000 });
  }

  btnUseCurrent.addEventListener("click", () => {
    setStatus("Ä‘ang láº¥y...", "warn");
    navigator.geolocation.getCurrentPosition(
      pos => onGeoSuccess(pos, { fillAddress: true }),
      onGeoError,
      { enableHighAccuracy: true, timeout: 20000 }
    );
  });
  // Submit form
  document.getElementById("testForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    submitStatus.textContent = "";
    if (!latEl.value || !lngEl.value) {
      setStatus("chÆ°a cÃ³ vá»‹ trÃ­. Vui lÃ²ng báº­t GPS hoáº·c báº¥m 'DÃ¹ng vá»‹ trÃ­ hiá»‡n táº¡i'", "err");
      return;
    }
    const formData = new FormData(this);
    btnSubmit.disabled = true;
    const prevText = btnSubmit.textContent;
    btnSubmit.textContent = "â³ Äang gá»­i...";
    try {
      const res = await fetch("https://script.google.com/macros/s/AKfycbxwYJObHC3zwAlNkFpNTCpAMlXBMOcGKg19VAXIFOcjy7r2k2x36S2uW_n-B_5RXUPOmw/exec", {
        method: "POST",
        body: formData
      });
      const text = await res.text();
      submitStatus.textContent = text;
      submitStatus.className = "status ok";
      this.reset();
      setStatus("chÆ°a láº¥y vá»‹ trÃ­.", "warn");
    } catch (err) {
      submitStatus.textContent = "âŒ Lá»—i gá»­i: " + err.message;
      submitStatus.className = "status err";
    } finally {
      btnSubmit.disabled = false;
      btnSubmit.textContent = prevText;
    }
  });

  // ğŸ“Œ ÄÄƒng kÃ½ Service Worker Ä‘á»ƒ trang nÃ y luÃ´n Ä‘Æ°á»£c cáº­p nháº­t
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(() => console.log("âœ… Service Worker Ä‘Ã£ Ä‘Äƒng kÃ½ cho dang-ky.html"))
      .catch(err => console.error("âŒ Lá»—i SW:", err));
  }
</script>
</body>
</html>
