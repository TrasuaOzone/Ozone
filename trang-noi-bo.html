<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Trang n·ªôi b·ªô nh√¢n vi√™n</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: #f4f6f8;}
  header {background: linear-gradient(90deg, #007bff, #0056b3); color: #fff; padding: 16px; text-align: center;}
  header h2 {margin: 0; font-weight: 500;}
  main {max-width: 800px; margin: 20px auto; padding: 0 16px;}
  .card {
    background: #fff; border-radius: 10px; padding: 20px; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;
  }
  .profile {
    display: flex; align-items: center; gap: 20px; border-bottom: 1px solid #ddd; padding-bottom: 16px; margin-bottom: 16px;
  }
  .profile img {
    width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #007bff;
  }
  .info label {font-weight: bold; color: #333;}
  .info div {margin-bottom: 8px;}
  button {
    background: #007bff; color: #fff; border: none; padding: 10px 16px; 
    border-radius: 5px; cursor: pointer; font-size: 14px;
  }
  button:hover {background: #0056b3;}
  .logout-btn {background: #dc3545;}
  .logout-btn:hover {background: #a71d2a;}
  #togglePass {color:#007bff; cursor:pointer; display:inline-block;}
  #togglePass:hover {text-decoration: underline;}
  .password-section input {
    width: 100%; padding: 8px; margin-top: 6px; margin-bottom: 12px; 
    border: 1px solid #ccc; border-radius: 5px;
  }
</style>
</head>
<body>

<header>
  <h2>Xin ch√†o, <span id="empName"></span></h2>
</header>

<main>
  <!-- Th√¥ng tin nh√¢n vi√™n -->
  <div class="card">
    <div class="profile">
      <img id="avatar" src="https://via.placeholder.com/120" alt="·∫¢nh ƒë·∫°i di·ªán">
      <div>
        <input type="file" id="uploadAvatar" accept="image/*">
      </div>
    </div>
    <div class="info">
      <div><label>M√£ NV:</label> <span id="staffCode"></span></div>
      <div><label>H·ªç t√™n:</label> <span id="name"></span></div>
      <div><label>S·ªë ƒëi·ªán tho·∫°i:</label> <span id="phone"></span></div>
      <div><label>CCCD:</label> <span id="idcard"></span></div>
      <div><label>Ng√†nh ngh·ªÅ:</label> <span id="job"></span></div>
      <div><label>Khu v·ª±c:</label> <span id="area"></span></div>
      <div><label>Th·ªùi gian l√†m:</label> <span id="time"></span></div>
      <div><label>Ghi ch√∫:</label> <span id="note"></span></div>
      <div><label>ƒê·ªãa ch·ªâ:</label> <span id="address"></span></div>
    </div>
  </div>

  <!-- ƒê·ªïi m·∫≠t kh·∫©u -->
  <div class="card password-section">
    <h3 id="togglePass">üîí ƒê·ªïi m·∫≠t kh·∫©u</h3>
    <div id="passForm" style="display:none; margin-top:15px;">
      <input type="password" id="oldPassword" placeholder="M·∫≠t kh·∫©u c≈©">
      <input type="password" id="newPassword" placeholder="M·∫≠t kh·∫©u m·ªõi">
      <input type="password" id="confirmPassword" placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi">
      <button id="changePassBtn">ƒê·ªïi m·∫≠t kh·∫©u</button>
      <div id="passStatus" style="margin-top:10px;font-size:14px;"></div>
    </div>
  </div>

  <button class="logout-btn" id="logout">ƒêƒÉng xu·∫•t</button>
</main>

<script>
  const idcard = localStorage.getItem("idcard");
  if (!idcard) {
    window.location.href = "dangnhap.html";
  } else {
    fetch("https://script.google.com/macros/s/AKfycbw2MgcXH5SRQFOoc9taeTbsLgECAGa3Br_pwFPSIIPs5BquoR_Nw5I8Ts4m4W-aY_4/exec?idcard=" + encodeURIComponent(idcard))
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
          localStorage.removeItem("idcard");
          window.location.href = "dangnhap.html";
        } else {
          document.getElementById('empName').textContent = data.name;
          document.getElementById('staffCode').textContent = data.staffCode;
          document.getElementById('name').textContent = data.name;
          document.getElementById('phone').textContent = data.phone;
          document.getElementById('idcard').textContent = data.idcard;
          document.getElementById('job').textContent = data.job;
          document.getElementById('area').textContent = data.area;
          document.getElementById('time').textContent = data.time;
          document.getElementById('note').textContent = data.note;
          document.getElementById('address').textContent = data.address;
        }
      });
  }

  // Toggle form ƒë·ªïi m·∫≠t kh·∫©u
  document.getElementById('togglePass').addEventListener('click', () => {
    const form = document.getElementById('passForm');
    form.style.display = (form.style.display === 'none') ? 'block' : 'none';
  });

  // ƒê·ªïi m·∫≠t kh·∫©u
  document.getElementById('changePassBtn').addEventListener('click', async () => {
    const oldPass = document.getElementById('oldPassword').value.trim();
    const newPass = document.getElementById('newPassword').value.trim();
    const confirmPass = document.getElementById('confirmPassword').value.trim();
    const statusEl = document.getElementById('passStatus');

    if (!oldPass || !newPass || !confirmPass) {
      statusEl.textContent = "‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin";
      statusEl.style.color = "red";
      return;
    }
    if (newPass !== confirmPass) {
      statusEl.textContent = "‚ö†Ô∏è M·∫≠t kh·∫©u m·ªõi v√† x√°c nh·∫≠n kh√¥ng kh·ªõp";
      statusEl.style.color = "red";
      return;
    }

    try {
      const res = await fetch("https://script.google.com/macros/s/AKfycbzwglaDuqcjckOjkkBAr4YQAGtZcliJxqZEcAFG5PtccwMuxsCZ7m1mXBU6i-bp0YY3pQ/exec", {
        method: "POST",
        body: new URLSearchParams({ idcard, oldPass, newPass })
      });
      const text = await res.text();
      statusEl.textContent = text;
      statusEl.style.color = text.includes("‚úÖ") ? "green" : "red";
      if (text.includes("‚úÖ")) {
        document.getElementById('oldPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
      }
    } catch (err) {
      statusEl.textContent = "‚ùå L·ªói k·∫øt n·ªëi: " + err.message;
      statusEl.style.color = "red";
    }
  });

  // ·∫¢nh ƒë·∫°i di·ªán local
  document.getElementById('uploadAvatar').addEventListener('change', e => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = ev => {
        document.getElementById('avatar').src = ev.target.result;
      };
      reader.readAsDataURL(file);
    }
  });

  // ƒêƒÉng xu·∫•t
  document.getElementById('logout').addEventListener('click', () => {
    localStorage.removeItem("idcard");
    window.location.href = "dang-nhap.html";
  });
</script>

</body>
</html>
